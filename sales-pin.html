<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sales Pin - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0c0e14;--surface:#161923;--surface2:#1e2230;--surface3:#262a3a;--border:#2a2f42;--text:#eaecf2;--text-dim:#7b829e;--blue:#4f8cff;--blue-bg:rgba(79,140,255,0.1);--blue-border:rgba(79,140,255,0.3);--green:#34d399;--green-bg:rgba(52,211,153,0.1);--orange:#fbbf24;--red:#f87171;--radius:14px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'IBM Plex Sans Thai',sans-serif;background:var(--bg);color:var(--text);height:100dvh;overflow:hidden;display:flex;flex-direction:column}

.status-bar{background:var(--surface);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.status-bar-left{display:flex;align-items:center;gap:8px}
.app-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--blue),#7c5cfc);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.app-title{font-size:15px;font-weight:600}
.app-title small{display:block;font-size:10px;font-weight:400;color:var(--text-dim)}
.conn-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;background:var(--red)}
.conn-dot.ok{background:var(--green)}
.sales-name-display{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:20px;font-size:12px;cursor:pointer;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.map-section{flex:1;position:relative;min-height:0}
#map{width:100%;height:100%}
.map-hint{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--blue-border);color:var(--blue);padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;z-index:800;pointer-events:none;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,0.5);display:none}
.map-hint.show{display:block}

.bottom-panel{background:var(--surface);border-top:1px solid var(--border);flex-shrink:0}
.nav-bar{display:flex;border-bottom:1px solid var(--border)}
.nav-item{flex:1;padding:10px 4px 8px;text-align:center;font-size:11px;font-weight:500;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
.nav-item .nav-icon{font-size:18px;display:block;margin-bottom:2px}
.nav-item.active{color:var(--blue);border-bottom-color:var(--blue)}

.screen{display:none;padding:14px 16px;max-height:45dvh;overflow-y:auto}
.screen.active{display:block}
.screen::-webkit-scrollbar{width:3px}
.screen::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

.big-gps-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--blue),#6366f1);border:none;border-radius:var(--radius);color:white;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 20px rgba(79,140,255,0.3);transition:all 0.2s;margin-bottom:10px}
.big-gps-btn:active{transform:scale(0.97)}
.big-gps-btn.loading{opacity:0.6}
.pick-map-label{text-align:center;font-size:11px;color:var(--text-dim);margin-bottom:12px}

.coord-display{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:8px;min-height:44px}
.coord-display.has-value{border-color:var(--green);background:var(--green-bg)}
.coord-text{font-size:13px;font-weight:500}
.coord-text.empty{color:var(--text-dim);font-weight:400}

.location-info{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--text-dim);display:none}
.location-info.show{display:block}
.location-info .loc-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px}
.location-info .loc-value{color:var(--text);font-weight:500}
.location-info.loading{color:var(--orange)}

.form-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:11px 14px;border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:border 0.2s;margin-bottom:10px}
.form-input:focus{border-color:var(--blue)}

.save-btn{width:100%;padding:14px;background:var(--green);border:none;border-radius:var(--radius);color:#0c0e14;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all 0.2s;margin-top:4px}
.save-btn:active{transform:scale(0.97)}
.save-btn:disabled{opacity:0.3;pointer-events:none}

.search-bar{position:relative;margin-bottom:8px}
.search-bar input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 14px 10px 36px;border-radius:10px;font-size:13px;font-family:inherit;outline:none}
.search-bar::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px}
.nearby-btn{width:100%;padding:10px;background:var(--orange-bg,rgba(251,191,36,0.08));border:1px solid rgba(251,191,36,0.25);border-radius:10px;color:var(--orange);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:6px;transition:all 0.15s}
.nearby-btn:active{transform:scale(0.97)}
.nearby-btn.loading{opacity:0.5}
.shop-item-dist{font-size:11px;color:var(--orange);font-weight:600}

.shop-item{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.15s}
.shop-item:active{background:var(--surface2)}
.shop-item-name{font-weight:600;font-size:14px;margin-bottom:3px}
.shop-item-loc{font-size:11px;color:var(--blue);margin-bottom:3px}
.shop-item-meta{font-size:11px;color:var(--text-dim);line-height:1.6}
.shop-item-actions{display:flex;gap:6px;margin-top:8px}
.mini-btn{font-size:11px;padding:5px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);cursor:pointer;font-family:inherit}
.mini-btn:active{background:var(--surface3)}
.mini-btn.nav-btn{border-color:var(--blue-border);color:var(--blue)}
.mini-btn.route-btn{border-color:rgba(52,211,153,0.3);color:var(--green)}

.route-empty{text-align:center;padding:24px;color:var(--text-dim);font-size:13px}
.route-item{display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:6px}
.route-num{width:26px;height:26px;background:var(--blue);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0}
.route-item-info{flex:1}
.route-item-name{font-size:13px;font-weight:600}
.route-item-sub{font-size:11px;color:var(--text-dim)}
.route-remove{background:none;border:none;color:var(--text-dim);font-size:16px;cursor:pointer;padding:4px}
.gmaps-route-btn{width:100%;padding:14px;background:linear-gradient(135deg,#34d399,#22d3ee);border:none;border-radius:var(--radius);color:#0c0e14;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;margin-top:8px;display:none}
.gmaps-route-btn:active{transform:scale(0.97)}
.clear-all-btn{width:100%;padding:10px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--text-dim);font-size:12px;font-family:inherit;cursor:pointer;margin-top:6px;display:none}

.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--surface);border:1px solid var(--green);color:var(--green);padding:10px 20px;border-radius:12px;font-size:13px;font-weight:500;z-index:9999;transition:transform 0.3s ease;box-shadow:0 4px 20px rgba(0,0,0,0.5);white-space:nowrap}
.toast.error{border-color:var(--red);color:var(--red)}
.toast.show{transform:translateX(-50%) translateY(0)}

.setup-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9000;display:flex;align-items:center;justify-content:center;padding:20px}
.setup-overlay.hidden{display:none}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px 24px;width:100%;max-width:340px;text-align:center}
.setup-card .app-icon{width:48px;height:48px;font-size:22px;margin:0 auto 16px;border-radius:14px}
.setup-card h2{font-size:18px;margin-bottom:6px}
.setup-card p{font-size:13px;color:var(--text-dim);margin-bottom:20px}
.setup-select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:12px;font-size:15px;font-family:inherit;text-align:center;outline:none;margin-bottom:14px;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237b829e'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.setup-btn{width:100%;padding:13px;background:var(--blue);border:none;border-radius:12px;color:white;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer}
.setup-btn:disabled{opacity:0.3}
.setup-warning{font-size:12px;color:var(--orange);margin-bottom:14px;padding:10px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:10px;display:none}
.setup-loading{font-size:12px;color:var(--text-dim);margin-bottom:14px}

.leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:12px!important;border:1px solid var(--border)!important;box-shadow:0 8px 30px rgba(0,0,0,0.5)!important}
.leaflet-popup-tip{background:var(--surface)!important}
.leaflet-popup-content{margin:10px 14px!important;font-family:'IBM Plex Sans Thai',sans-serif!important;font-size:13px!important}
.custom-pin{width:24px;height:24px;background:var(--blue);border:2px solid white;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 2px 6px rgba(0,0,0,0.4)}
.custom-pin.in-route{background:var(--green);width:28px;height:28px}
.custom-pin.temp{background:var(--orange);animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,0.4)}50%{box-shadow:0 0 0 10px rgba(251,191,36,0)}}
</style>
</head>
<body>

<div class="setup-overlay" id="setupOverlay">
  <div class="setup-card">
    <div class="app-icon">üìç</div>
    <h2>Sales Pin</h2>
    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
    <div class="setup-loading" id="setupLoading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>
    <div class="setup-warning" id="setupWarning"></div>
    <select class="setup-select" id="setupSelect" onchange="document.getElementById('setupBtn').disabled=!this.value" style="display:none">
      <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>
    </select>
    <button class="setup-btn" id="setupBtn" disabled onclick="completeSetup()" style="display:none">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
  </div>
</div>

<div class="status-bar">
  <div class="status-bar-left">
    <div class="app-icon">üìç</div>
    <div class="app-title">Sales Pin <small><span class="conn-dot" id="connDot"></span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</small></div>
  </div>
  <div class="sales-name-display" id="salesNameDisplay" onclick="showSetup()">üë§ -</div>
</div>

<div class="map-section">
  <div class="map-hint" id="mapHint">üëÜ ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
  <div id="map"></div>
</div>

<div class="bottom-panel">
  <div class="nav-bar">
    <div class="nav-item active" onclick="switchScreen('pin')"><span class="nav-icon">üìå</span> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</div>
    <div class="nav-item" onclick="switchScreen('shops')"><span class="nav-icon">üìã</span> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
    <div class="nav-item" onclick="switchScreen('route')"><span class="nav-icon">üó∫Ô∏è</span> ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á <span id="routeBadge" style="display:none;background:var(--green);color:#0c0e14;padding:1px 6px;border-radius:10px;font-size:10px;font-weight:700"></span></div>
  </div>

  <div class="screen active" id="screenPin">
    <button class="big-gps-btn" id="gpsBtn" onclick="captureGPS()">üì° ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
    <div class="pick-map-label">‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>

    <div class="coord-display" id="coordDisplay">
      <span class="coord-text empty" id="coordText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>
    </div>

    <!-- Auto-detected location -->
    <div class="location-info" id="locationInfo">
      <div class="loc-label">üìç ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
      <div class="loc-value" id="locValue">-</div>
    </div>

    <input class="form-input" id="fName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ *" oninput="checkReady()">
    <input class="form-input" id="fPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏£‡πâ‡∏≤‡∏ô">
    <input class="form-input" id="fNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    <button class="save-btn" id="saveBtn" disabled onclick="saveShop()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
  </div>

  <div class="screen" id="screenShops">
    <div class="search-bar"><input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô..." oninput="clearNearby();renderShops()"></div>
    <button class="nearby-btn" id="nearbyBtn" onclick="searchNearby()">üì° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô (100 ‡∏°.)</button>
    <div id="shopsList"></div>
  </div>

  <div class="screen" id="screenRoute">
    <div id="routeList"></div>
    <button class="gmaps-route-btn" id="gmapsBtn" onclick="openGmapsRoute()">üó∫Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
    <button class="clear-all-btn" id="clearBtn" onclick="clearRoute()">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚öôÔ∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const API_URL = 'https://script.google.com/macros/s/AKfycbyWJGCku3wxI0tR0l0CX3RGj7P8OT_ccbTaCVu82Cuqe3tJC4ar7SZDfsuCLO8Yeb8J/exec';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let myShops=[],route=[],salesTeam=[],salesName='';
let selectedLat=null,selectedLng=null,detectedProvince='',detectedDistrict='';
let tempMarker=null,markers={};

const map=L.map('map',{center:[18.7883,98.9853],zoom:10,zoomControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM',maxZoom:19}).addTo(map);
L.control.zoom({position:'topright'}).addTo(map);

map.on('click',e=>{
  selectedLat=+e.latlng.lat.toFixed(6);selectedLng=+e.latlng.lng.toFixed(6);
  updateCoord();placeTempPin(selectedLat,selectedLng);checkReady();switchScreen('pin');
  reverseGeocode(selectedLat,selectedLng);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVERSE GEOCODING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function reverseGeocode(lat,lng){
  const info=document.getElementById('locationInfo');
  const val=document.getElementById('locValue');
  info.classList.add('show');
  info.classList.add('loading');
  val.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á...';
  detectedProvince='';detectedDistrict='';

  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=th&addressdetails=1`);
    const j=await r.json();
    const a=j.address||{};
    const dn=j.display_name||'';

    // ‚ïê‚ïê‚ïê ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Äî ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å display_name ‡∏Å‡πà‡∏≠‡∏ô ‚ïê‚ïê‚ïê
    const provMatch=dn.match(/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î([^\s,]+)/);
    if(provMatch) detectedProvince=provMatch[1];
    if(!detectedProvince) detectedProvince=(a.state||a.province||'').toString().replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/,'').replace(/,/g,'').trim();

    // ‚ïê‚ïê‚ïê ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚Äî ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å display_name ‡∏Å‡πà‡∏≠‡∏ô (‡πÑ‡∏î‡πâ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≥‡∏ö‡∏•) ‚ïê‚ïê‚ïê
    const distMatch=dn.match(/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠([^\s,]+)/);
    if(distMatch) detectedDistrict=distMatch[1];
    // ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡πÉ‡∏ä‡πâ "‡πÄ‡∏Ç‡∏ï"
    if(!detectedDistrict){
      const khetMatch=dn.match(/‡πÄ‡∏Ç‡∏ï([^\s,]+)/);
      if(khetMatch) detectedDistrict=khetMatch[1];
    }
    // fallback: county ‡∏à‡∏≤‡∏Å address
    if(!detectedDistrict){
      const county=(a.county||'').toString().replace(/^‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/,'').replace(/^‡πÄ‡∏Ç‡∏ï/,'').trim();
      if(county) detectedDistrict=county;
    }

    if(detectedProvince||detectedDistrict){
      info.classList.remove('loading');
      let parts=[];
      if(detectedDistrict) parts.push('‡∏≠.'+detectedDistrict);
      if(detectedProvince) parts.push('‡∏à.'+detectedProvince);
      val.textContent=parts.join(' ¬∑ ');
    } else {
      info.classList.remove('loading');
      val.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á';
    }
  }catch(e){
    info.classList.remove('loading');
    val.textContent='‚ö†Ô∏è ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡πá‡∏ï?)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiGet(action,params=''){
  if(!API_URL)return null;
  try{const r=await fetch(`${API_URL}?action=${action}${params}`);const j=await r.json();return j.ok?j.data:null;}catch(e){return null;}
}
async function apiPost(action,data){
  if(!API_URL)return null;
  try{const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action,...data})});const j=await r.json();return j.ok?j.data:null;}catch(e){return null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  salesName=localStorage.getItem('salespin-myname')||'';
  if(!API_URL){
    document.getElementById('setupLoading').textContent='‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API_URL';
    document.getElementById('setupWarning').style.display='block';
    document.getElementById('setupWarning').innerHTML='‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô';
    return;
  }
  const team=await apiGet('getTeam');
  if(team){salesTeam=team;document.getElementById('connDot').classList.add('ok');}
  populateDropdown();
  if(salesName&&salesTeam.includes(salesName)){
    document.getElementById('setupOverlay').classList.add('hidden');
    document.getElementById('salesNameDisplay').textContent='üë§ '+salesName;
    loadMyShops();
  } else { document.getElementById('setupOverlay').classList.remove('hidden'); }
}

async function loadMyShops(){
  if(!salesName)return;
  const data=await apiGet('getShops',`&sales=${encodeURIComponent(salesName)}`);
  if(data){myShops=data;renderAll();}
}

function populateDropdown(){
  const sel=document.getElementById('setupSelect'),ld=document.getElementById('setupLoading'),w=document.getElementById('setupWarning');
  ld.style.display='none';
  if(!salesTeam.length){w.style.display='block';w.innerHTML='‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô';return;}
  w.style.display='none';sel.style.display='block';document.getElementById('setupBtn').style.display='block';
  sel.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>';
  salesTeam.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;if(n===salesName)o.selected=true;sel.appendChild(o);});
  if(salesName&&salesTeam.includes(salesName))document.getElementById('setupBtn').disabled=false;
}

function completeSetup(){
  const v=document.getElementById('setupSelect').value;if(!v)return;
  salesName=v;localStorage.setItem('salespin-myname',salesName);
  document.getElementById('setupOverlay').classList.add('hidden');
  document.getElementById('salesNameDisplay').textContent='üë§ '+salesName;
  showToast('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ '+salesName+'!');loadMyShops();
}
function showSetup(){populateDropdown();document.getElementById('setupOverlay').classList.remove('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function captureGPS(){
  const btn=document.getElementById('gpsBtn');
  btn.classList.add('loading');btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
  if(!navigator.geolocation){showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS',true);resetGps();return;}
  navigator.geolocation.getCurrentPosition(p=>{
    selectedLat=+p.coords.latitude.toFixed(6);selectedLng=+p.coords.longitude.toFixed(6);
    updateCoord();placeTempPin(selectedLat,selectedLng);map.setView([selectedLat,selectedLng],16);
    checkReady();resetGps();showToast('‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
    reverseGeocode(selectedLat,selectedLng);
  },e=>{
    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    let msg='‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ';
    switch(e.code){
      case 1: msg+='‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‚Äî ‡∏Å‡∏î‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô üîí ‡∏ó‡∏µ‡πà address bar ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Location'; break;
      case 2: msg+='‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î GPS/Location ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠'; break;
      case 3: msg+='‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‚Äî ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á'; break;
      default: msg+=e.message||'‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏';
    }
    showToast(msg,true);resetGps();
  },{enableHighAccuracy:true,timeout:15000});
}
function resetGps(){const b=document.getElementById('gpsBtn');b.classList.remove('loading');b.textContent='üì° ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEARBY SEARCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let nearbyMode=false;
let myCurrentLat=null,myCurrentLng=null;

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;// ‡πÄ‡∏°‡∏ï‡∏£
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

function searchNearby(){
  const btn=document.getElementById('nearbyBtn');
  if(nearbyMode){clearNearby();renderShops();return;}
  if(!navigator.geolocation){showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS',true);return;}
  btn.classList.add('loading');btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
  navigator.geolocation.getCurrentPosition(p=>{
    myCurrentLat=p.coords.latitude;myCurrentLng=p.coords.longitude;
    nearbyMode=true;
    btn.classList.remove('loading');
    btn.textContent='‚úï ‡∏õ‡∏¥‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô';
    btn.style.borderColor='var(--blue-border)';btn.style.color='var(--blue)';
    document.getElementById('searchInput').value='';
    renderShops();
    // ‡∏ã‡∏π‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    map.setView([myCurrentLat,myCurrentLng],16);
  },e=>{
    let msg='‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ';
    if(e.code===1) msg+='‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Location';
    else if(e.code===2) msg+='‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î GPS';
    else msg+='‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
    showToast(msg,true);
    btn.classList.remove('loading');btn.textContent='üì° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô (100 ‡∏°.)';
  },{enableHighAccuracy:true,timeout:15000});
}

function clearNearby(){
  nearbyMode=false;myCurrentLat=null;myCurrentLng=null;
  const btn=document.getElementById('nearbyBtn');
  btn.textContent='üì° ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏â‡∏±‡∏ô (100 ‡∏°.)';
  btn.style.borderColor='';btn.style.color='';
}

function updateCoord(){
  const el=document.getElementById('coordDisplay'),tx=document.getElementById('coordText');
  if(selectedLat!==null){el.classList.add('has-value');tx.classList.remove('empty');tx.innerHTML=`${selectedLat}, ${selectedLng} <span style="color:var(--green)">‚úì</span>`;}
  else{el.classList.remove('has-value');tx.classList.add('empty');tx.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î';document.getElementById('locationInfo').classList.remove('show');}
}
function checkReady(){document.getElementById('saveBtn').disabled=!(selectedLat!==null&&document.getElementById('fName').value.trim());}

function saveShop(){
  const shop={
    id:Date.now().toString(36)+Math.random().toString(36).substr(2,5),
    name:document.getElementById('fName').value.trim(),
    lat:selectedLat,lng:selectedLng,
    province:detectedProvince,
    district:detectedDistrict,
    sales:salesName,
    phone:document.getElementById('fPhone').value.trim(),
    note:document.getElementById('fNote').value.trim(),
    createdAt:new Date().toISOString()
  };

  // Optimistic UI
  myShops.unshift(shop);renderAll();
  showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${shop.name}" ‡πÅ‡∏•‡πâ‡∏ß!`);
  map.setView([shop.lat,shop.lng],14);

  // Clear form
  document.getElementById('fName').value='';document.getElementById('fPhone').value='';document.getElementById('fNote').value='';
  selectedLat=null;selectedLng=null;detectedProvince='';detectedDistrict='';
  updateCoord();document.getElementById('saveBtn').disabled=true;
  if(tempMarker){map.removeLayer(tempMarker);tempMarker=null;}

  // Background save
  apiPost('addShop',{data:shop}).then(r=>{if(!r)showToast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',true);});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MARKERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pinIcon(inR){return L.divIcon({className:'',html:`<div class="custom-pin ${inR?'in-route':''}"></div>`,iconSize:inR?[28,28]:[24,24],iconAnchor:inR?[14,28]:[12,24],popupAnchor:[0,-24]})}
function placeTempPin(lat,lng){if(tempMarker)map.removeLayer(tempMarker);tempMarker=L.marker([lat,lng],{icon:L.divIcon({className:'',html:'<div class="custom-pin temp"></div>',iconSize:[24,24],iconAnchor:[12,24]})}).addTo(map)}
function renderMarkers(){
  Object.values(markers).forEach(m=>map.removeLayer(m));markers={};
  myShops.forEach(s=>{
    const inR=route.some(r=>r.id===s.id);
    const m=L.marker([s.lat,s.lng],{icon:pinIcon(inR)}).addTo(map);
    let locLine='';
    if(s.district||s.province){
      let p=[];if(s.district)p.push('‡∏≠.'+s.district);if(s.province)p.push('‡∏à.'+s.province);
      locLine='üìç '+p.join(' ')+'<br>';
    }
    m.bindPopup(`<div style="font-weight:600">${s.name}</div><div style="color:var(--text-dim);font-size:12px;margin-top:4px">${locLine}${s.phone?'üìû '+s.phone+'<br>':''}${s.note?'üìù '+s.note:''}</div><a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}" target="_blank" style="color:var(--blue);font-size:12px;text-decoration:none">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>`);
    markers[s.id]=m;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOP LIST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderShops(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase();
  let list;

  if(nearbyMode && myCurrentLat!==null){
    // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏Å‡∏•‡πâ ‚Äî ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚â§100 ‡∏°.
    list=myShops.map(s=>({...s, dist:haversine(myCurrentLat,myCurrentLng,s.lat,s.lng)}))
      .filter(s=>s.dist<=100)
      .sort((a,b)=>a.dist-b.dist);
  } else {
    list=myShops.filter(s=>!q||s.name.toLowerCase().includes(q)||(s.phone||'').includes(q)||(s.district||'').includes(q));
  }

  const el=document.getElementById('shopsList');
  if(!list.length){
    const msg=nearbyMode?'üì° ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 100 ‡πÄ‡∏°‡∏ï‡∏£':(myShops.length?'üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö':'üìç ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
    el.innerHTML=`<div style="text-align:center;padding:24px;color:var(--text-dim);font-size:13px">${msg}</div>`;return;
  }
  el.innerHTML=list.slice(0,50).map(s=>{
    const inR=route.some(r=>r.id===s.id);
    const d=new Date(s.createdAt).toLocaleDateString('th-TH',{day:'numeric',month:'short'});
    let loc='';if(s.district||s.province){let p=[];if(s.district)p.push('‡∏≠.'+s.district);if(s.province)p.push('‡∏à.'+s.province);loc=p.join(' ¬∑ ');}
    const distLabel=(nearbyMode && s.dist!=null)?`<span class="shop-item-dist">üìè ${Math.round(s.dist)} ‡∏°.</span> ¬∑ `:'';
    return `<div class="shop-item" onclick="focusShop('${s.id}')">
      <div class="shop-item-name">${s.name}</div>
      ${loc?`<div class="shop-item-loc">üìç ${loc}</div>`:''}
      <div class="shop-item-meta">${distLabel}${s.phone?'üìû '+s.phone+' ¬∑ ':''}${d}${s.note?' ¬∑ üìù '+s.note:''}</div>
      <div class="shop-item-actions">
        <button class="mini-btn nav-btn" onclick="event.stopPropagation();openNav('${s.id}')">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
        <button class="mini-btn route-btn" onclick="event.stopPropagation();toggleRoute('${s.id}')">${inR?'‚úÖ ‡πÉ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á':'üìå ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á'}</button>
      </div>
    </div>`;
  }).join('')+(list.length>50?`<div style="text-align:center;padding:12px;color:var(--text-dim);font-size:11px">‡πÅ‡∏™‡∏î‡∏á 50 ‡∏à‡∏≤‡∏Å ${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`:'');
}
function focusShop(id){const s=myShops.find(x=>x.id===id);if(s){map.setView([s.lat,s.lng],16);if(markers[id])markers[id].openPopup();}}
function openNav(id){const s=myShops.find(x=>x.id===id);if(s)window.open(`https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}`,'_blank');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROUTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleRoute(id){const i=route.findIndex(r=>r.id===id);if(i>-1)route.splice(i,1);else{const s=myShops.find(x=>x.id===id);if(s)route.push(s);}renderAll();}
function renderRoute(){
  const el=document.getElementById('routeList'),badge=document.getElementById('routeBadge'),gb=document.getElementById('gmapsBtn'),cb=document.getElementById('clearBtn');
  if(!route.length){badge.style.display='none';gb.style.display='none';cb.style.display='none';el.innerHTML='<div class="route-empty">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å üìã ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á"</div>';return;}
  badge.style.display='inline';badge.textContent=route.length;gb.style.display='block';cb.style.display='block';
  el.innerHTML=route.map((s,i)=>{
    let loc='';if(s.district)loc='‡∏≠.'+s.district;
    return `<div class="route-item"><div class="route-num">${i+1}</div><div class="route-item-info"><div class="route-item-name">${s.name}</div><div class="route-item-sub">${loc?loc+' ¬∑ ':''}${s.phone?'üìû '+s.phone:''}</div></div><button class="route-remove" onclick="toggleRoute('${s.id}')">‚úï</button></div>`;
  }).join('');
}
function openGmapsRoute(){
  if(!route.length)return;
  if(route.length===1){window.open(`https://www.google.com/maps/dir/?api=1&destination=${route[0].lat},${route[0].lng}`,'_blank');return;}
  const o=route[0],d=route[route.length-1],wp=route.slice(1,-1).map(s=>`${s.lat},${s.lng}`).join('|');
  let url=`https://www.google.com/maps/dir/?api=1&origin=${o.lat},${o.lng}&destination=${d.lat},${d.lng}`;
  if(wp)url+=`&waypoints=${wp}`;url+='&travelmode=driving';window.open(url,'_blank');
}
function clearRoute(){route=[];renderAll();showToast('‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');}

function switchScreen(name){
  ['pin','shops','route'].forEach(s=>document.getElementById('screen'+s[0].toUpperCase()+s.slice(1)).classList.toggle('active',s===name));
  document.querySelectorAll('.nav-item').forEach((el,i)=>el.classList.toggle('active',(name==='pin'&&i===0)||(name==='shops'&&i===1)||(name==='route'&&i===2)));
  document.getElementById('mapHint').classList.toggle('show',name==='pin');
}
function renderAll(){renderMarkers();renderShops();renderRoute();}
function showToast(msg,isErr){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(isErr?' error':'');setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),2500);}

init();
setTimeout(()=>map.invalidateSize(),150);
</script>
</body>
</html>
