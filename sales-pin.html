<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Sales Pin - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<style>
:root{--bg:#0c0e14;--surface:#161923;--surface2:#1e2230;--surface3:#262a3a;--border:#2a2f42;--text:#eaecf2;--text-dim:#7b829e;--blue:#4f8cff;--blue-bg:rgba(79,140,255,0.1);--blue-border:rgba(79,140,255,0.3);--green:#34d399;--green-bg:rgba(52,211,153,0.1);--orange:#fbbf24;--red:#f87171;--radius:14px}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'IBM Plex Sans Thai',sans-serif;background:var(--bg);color:var(--text);height:100dvh;overflow:hidden;display:flex;flex-direction:column}

.status-bar{background:var(--surface);padding:10px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0}
.status-bar-left{display:flex;align-items:center;gap:8px}
.app-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--blue),#7c5cfc);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.app-title{font-size:15px;font-weight:600}
.app-title small{display:block;font-size:10px;font-weight:400;color:var(--text-dim)}
.conn-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;background:var(--red)}
.conn-dot.ok{background:var(--green)}
.sales-name-display{background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:20px;font-size:12px;cursor:pointer;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

.map-section{flex:1;position:relative;min-height:0}
#map{width:100%;height:100%}
.map-hint{position:absolute;top:10px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--blue-border);color:var(--blue);padding:6px 14px;border-radius:20px;font-size:12px;font-weight:500;z-index:800;pointer-events:none;white-space:nowrap;box-shadow:0 4px 16px rgba(0,0,0,0.5);display:none}
.map-hint.show{display:block}

.bottom-panel{background:var(--surface);border-top:1px solid var(--border);flex-shrink:0}
.nav-bar{display:flex;border-bottom:1px solid var(--border)}
.nav-item{flex:1;padding:10px 4px 8px;text-align:center;font-size:11px;font-weight:500;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
.nav-item .nav-icon{font-size:18px;display:block;margin-bottom:2px}
.nav-item.active{color:var(--blue);border-bottom-color:var(--blue)}

.screen{display:none;padding:14px 16px;max-height:45dvh;overflow-y:auto}
.screen.active{display:block}
.screen::-webkit-scrollbar{width:3px}
.screen::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

.big-gps-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--blue),#6366f1);border:none;border-radius:var(--radius);color:white;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 20px rgba(79,140,255,0.3);transition:all 0.2s;margin-bottom:10px}
.big-gps-btn:active{transform:scale(0.97)}
.big-gps-btn.loading{opacity:0.6}
.pick-map-label{text-align:center;font-size:11px;color:var(--text-dim);margin-bottom:12px}

.coord-display{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:8px;min-height:44px}
.coord-display.has-value{border-color:var(--green);background:var(--green-bg)}
.coord-text{font-size:13px;font-weight:500}
.coord-text.empty{color:var(--text-dim);font-weight:400}

.location-info{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--text-dim);display:none}
.location-info.show{display:block}
.location-info .loc-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px}
.location-info .loc-value{color:var(--text);font-weight:500}
.location-info.loading{color:var(--orange)}

.form-input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:11px 14px;border-radius:10px;font-size:14px;font-family:inherit;outline:none;transition:border 0.2s;margin-bottom:10px}
.form-input:focus{border-color:var(--blue)}

.save-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--orange),#f97316);border:none;border-radius:var(--radius);color:#0c0e14;font-size:15px;font-weight:700;font-family:inherit;cursor:pointer;transition:all 0.2s;margin-top:4px;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 20px rgba(251,191,36,0.3);position:relative;overflow:hidden}
.save-btn:active{transform:scale(0.97)}
.save-btn:disabled{opacity:0.3;pointer-events:none}
.save-btn input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}

.search-bar{position:relative;margin-bottom:8px}
.search-bar input{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 14px 10px 36px;border-radius:10px;font-size:13px;font-family:inherit;outline:none}
.search-bar::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px}
.nearby-status{text-align:center;padding:8px;font-size:11px;color:var(--text-dim);margin-bottom:8px}
.nearby-status .count{color:var(--green);font-weight:700}
.shop-item-dist{font-size:11px;color:var(--orange);font-weight:600}
.shop-item-owner{font-size:10px;color:var(--text-dim);background:var(--surface3);padding:1px 7px;border-radius:4px;margin-left:6px;font-weight:500}
.shop-item-owner.mine{color:var(--blue);background:var(--blue-bg)}

/* ‚ïê‚ïê CHECK-IN MODAL ‚ïê‚ïê */
.checkin-modal{position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9200;display:none;align-items:flex-end;justify-content:center;padding:0}
.checkin-modal.show{display:flex}
.checkin-sheet{background:var(--surface);width:100%;max-height:75dvh;border-radius:20px 20px 0 0;padding:20px 16px env(safe-area-inset-bottom,16px);overflow-y:auto}
.checkin-sheet-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px}
.checkin-title{font-size:16px;font-weight:700;margin-bottom:4px}
.checkin-subtitle{font-size:12px;color:var(--text-dim);margin-bottom:16px}
.checkin-shop-card{background:var(--bg);border:2px solid var(--green);border-radius:14px;padding:14px;margin-bottom:10px;cursor:pointer;transition:all 0.15s}
.checkin-shop-card:active{transform:scale(0.98)}
.checkin-shop-card .csc-name{font-size:15px;font-weight:700;margin-bottom:3px}
.checkin-shop-card .csc-info{font-size:12px;color:var(--text-dim)}
.checkin-shop-card .csc-dist{font-size:12px;color:var(--green);font-weight:600;margin-top:4px}
.checkin-divider{text-align:center;color:var(--text-dim);font-size:12px;margin:14px 0;position:relative}
.checkin-divider::before,.checkin-divider::after{content:'';position:absolute;top:50%;width:calc(50% - 40px);height:1px;background:var(--border)}
.checkin-divider::before{left:0}.checkin-divider::after{right:0}
.checkin-new-btn{width:100%;padding:14px;border:1px dashed var(--border);border-radius:14px;background:transparent;color:var(--text-dim);font-size:14px;font-weight:500;font-family:inherit;cursor:pointer;transition:all 0.15s}
.checkin-new-btn:active{background:var(--surface2)}
.checkin-cancel{width:100%;padding:12px;border:none;background:transparent;color:var(--text-dim);font-size:13px;font-family:inherit;cursor:pointer;margin-top:10px}

.shop-item{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.15s}
.shop-item:active{background:var(--surface2)}
.shop-item-name{font-weight:600;font-size:14px;margin-bottom:3px}
.shop-item-loc{font-size:11px;color:var(--blue);margin-bottom:3px}
.shop-item-meta{font-size:11px;color:var(--text-dim);line-height:1.6}
.shop-item-actions{display:flex;gap:6px;margin-top:8px}
.mini-btn{font-size:11px;padding:5px 10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);cursor:pointer;font-family:inherit}
.mini-btn:active{background:var(--surface3)}
.mini-btn.nav-btn{border-color:var(--blue-border);color:var(--blue)}
.mini-btn.cam-btn{border-color:rgba(251,191,36,0.3);color:var(--orange);position:relative;overflow:hidden}
.mini-btn.cam-btn input{position:absolute;inset:0;opacity:0;cursor:pointer}

/* ‚ïê‚ïê PHOTO MODAL ‚ïê‚ïê */
.photo-modal{position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:9500;display:none;flex-direction:column;padding:0}
.photo-modal.show{display:flex}
.photo-modal-content{width:100%;height:100%;display:flex;flex-direction:column;padding:16px;overflow-y:auto}
.photo-modal-img-wrap{flex-shrink:0;max-height:55dvh;border-radius:12px;overflow:hidden;border:1px solid var(--border);margin-bottom:12px}
.photo-modal-img-wrap img{width:100%;height:100%;object-fit:contain;display:block}
.photo-modal-info{font-size:14px;color:var(--text);margin-bottom:14px;line-height:1.6;text-align:center;flex-shrink:0}
.photo-modal-actions{display:flex;gap:10px;flex-shrink:0;padding-bottom:env(safe-area-inset-bottom,16px)}
.photo-modal-btn{flex:1;padding:16px;border:none;border-radius:12px;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer}
.photo-modal-btn.share{background:var(--green);color:#0c0e14}
.photo-modal-btn.close{background:var(--surface2);border:1px solid var(--border);color:var(--text-dim)}

.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-80px);background:var(--surface);border:1px solid var(--green);color:var(--green);padding:10px 20px;border-radius:12px;font-size:13px;font-weight:500;z-index:9999;transition:transform 0.3s ease;box-shadow:0 4px 20px rgba(0,0,0,0.5);max-width:90%;text-align:center}
.toast.error{border-color:var(--red);color:var(--red)}
.toast.show{transform:translateX(-50%) translateY(0)}

.setup-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9000;display:flex;align-items:center;justify-content:center;padding:20px}
.setup-overlay.hidden{display:none}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px 24px;width:100%;max-width:340px;text-align:center}
.setup-card .app-icon{width:48px;height:48px;font-size:22px;margin:0 auto 16px;border-radius:14px}
.setup-card h2{font-size:18px;margin-bottom:6px}
.setup-card p{font-size:13px;color:var(--text-dim);margin-bottom:20px}
.setup-select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:12px 16px;border-radius:12px;font-size:15px;font-family:inherit;text-align:center;outline:none;margin-bottom:14px;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237b829e'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.setup-btn{width:100%;padding:13px;background:var(--blue);border:none;border-radius:12px;color:white;font-size:15px;font-weight:600;font-family:inherit;cursor:pointer}
.setup-btn:disabled{opacity:0.3}
.setup-warning{font-size:12px;color:var(--orange);margin-bottom:14px;padding:10px;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:10px;display:none}
.setup-loading{font-size:12px;color:var(--text-dim);margin-bottom:14px}

.leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:12px!important;border:1px solid var(--border)!important;box-shadow:0 8px 30px rgba(0,0,0,0.5)!important}
.leaflet-popup-tip{background:var(--surface)!important}
.leaflet-popup-content{margin:10px 14px!important;font-family:'IBM Plex Sans Thai',sans-serif!important;font-size:13px!important}
.custom-pin{width:24px;height:24px;background:var(--blue);border:2px solid white;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 2px 6px rgba(0,0,0,0.4)}
.custom-pin.mine{background:var(--green)}
.custom-pin.temp{background:var(--orange);animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,0.4)}50%{box-shadow:0 0 0 10px rgba(251,191,36,0)}}
</style>
</head>
<body>

<div class="setup-overlay" id="setupOverlay">
  <div class="setup-card">
    <div class="app-icon">üìç</div>
    <h2>Sales Pin</h2>
    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
    <div class="setup-loading" id="setupLoading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</div>
    <div class="setup-warning" id="setupWarning"></div>
    <select class="setup-select" id="setupSelect" onchange="document.getElementById('setupBtn').disabled=!this.value" style="display:none"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå --</option></select>
    <button class="setup-btn" id="setupBtn" disabled onclick="completeSetup()" style="display:none">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
  </div>
</div>

<div class="status-bar">
  <div class="status-bar-left">
    <div class="app-icon">üìç</div>
    <div class="app-title">Sales Pin <small><span class="conn-dot" id="connDot"></span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</small></div>
  </div>
  <div class="sales-name-display" id="salesNameDisplay" onclick="showSetup()">üë§ -</div>
</div>

<div class="map-section">
  <div class="map-hint" id="mapHint">üëÜ ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</div>
  <div id="map"></div>
</div>

<div class="bottom-panel">
  <div class="nav-bar">
    <div class="nav-item active" onclick="switchScreen('pin')"><span class="nav-icon">üìå</span> ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î</div>
    <div class="nav-item" onclick="switchScreen('shops')"><span class="nav-icon">üìã</span> ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</div>
  </div>

  <!-- ‚ïê‚ïê ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î ‚ïê‚ïê -->
  <div class="screen active" id="screenPin">
    <button class="big-gps-btn" id="gpsBtn" onclick="captureGPS()">üì° ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</button>
    <div class="pick-map-label">‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
    <div class="coord-display" id="coordDisplay"><span class="coord-text empty" id="coordText">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</span></div>
    <div class="location-info" id="locationInfo"><div class="loc-label">üìç ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div><div class="loc-value" id="locValue">-</div></div>
    <input class="form-input" id="fName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ *" oninput="checkReady()">
    <input class="form-input" id="fPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏£‡πâ‡∏≤‡∏ô">
    <input class="form-input" id="fNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
    <button class="save-btn" id="saveBtn" disabled>
      üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
      <input type="file" id="savePhotoInput" accept="image/*" capture="environment" onchange="onSavePhoto(event)">
    </button>
  </div>

  <!-- ‚ïê‚ïê ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 100 ‡πÄ‡∏°‡∏ï‡∏£) ‚ïê‚ïê -->
  <div class="screen" id="screenShops">
    <div class="nearby-status" id="nearbyStatus">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...</div>
    <div class="search-bar"><input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á..." oninput="renderShops()"></div>
    <div id="shopsList"></div>
  </div>
</div>

<!-- Check-in suggestion modal -->
<div class="checkin-modal" id="checkinModal">
  <div class="checkin-sheet">
    <div class="checkin-sheet-handle"></div>
    <div class="checkin-title">üìç ‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</div>
    <div class="checkin-subtitle">‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà?</div>
    <div id="checkinShopList"></div>
    <div class="checkin-divider">‡∏´‡∏£‡∏∑‡∏≠</div>
    <button class="checkin-new-btn" onclick="closeCheckinModal();proceedAddNew()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
    <button class="checkin-cancel" onclick="closeCheckinModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<!-- Photo result modal -->
<div class="photo-modal" id="photoModal">
  <div class="photo-modal-content">
    <div class="photo-modal-img-wrap"><img id="photoModalImg"></div>
    <div class="photo-modal-info" id="photoModalInfo"></div>
    <div class="photo-modal-actions">
      <button class="photo-modal-btn close" onclick="closePhotoModal()">‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à</button>
      <button class="photo-modal-btn share" onclick="shareCurrentPhoto()">üì§ ‡∏™‡πà‡∏á LINE</button>
    </div>
  </div>
</div>

<canvas id="camCanvas" style="display:none"></canvas>
<div class="toast" id="toast"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyWJGCku3wxI0tR0l0CX3RGj7P8OT_ccbTaCVu82Cuqe3tJC4ar7SZDfsuCLO8Yeb8J/exec';
const SHOP_CACHE_KEY = 'salespin-allshops';
const SHOP_CACHE_TTL = 30 * 60 * 1000; // 30 ‡∏ô‡∏≤‡∏ó‡∏µ

let allShops=[],salesTeam=[],salesName='';
let selectedLat=null,selectedLng=null,detectedProvince='',detectedDistrict='';
let tempMarker=null,markers={};
let lastPhotoShop=null;
let myLat=null,myLng=null; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

const map=L.map('map',{center:[18.7883,98.9853],zoom:10,zoomControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM',maxZoom:19}).addTo(map);
L.control.zoom({position:'topright'}).addTo(map);

map.on('click',e=>{
  selectedLat=+e.latlng.lat.toFixed(6);selectedLng=+e.latlng.lng.toFixed(6);
  updateCoord();placeTempPin(selectedLat,selectedLng);checkReady();switchScreen('pin');
  reverseGeocode(selectedLat,selectedLng);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVERSE GEOCODING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function reverseGeocode(lat,lng){
  const info=document.getElementById('locationInfo'),val=document.getElementById('locValue');
  info.classList.add('show','loading');val.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á...';
  detectedProvince='';detectedDistrict='';
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=th&addressdetails=1`);
    const j=await r.json();const a=j.address||{},dn=j.display_name||'';
    const pm=dn.match(/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î([^\s,]+)/);if(pm)detectedProvince=pm[1];
    if(!detectedProvince)detectedProvince=(a.state||a.province||'').toString().replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/,'').replace(/,/g,'').trim();
    const dm=dn.match(/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠([^\s,]+)/);if(dm)detectedDistrict=dm[1];
    if(!detectedDistrict){const k=dn.match(/‡πÄ‡∏Ç‡∏ï([^\s,]+)/);if(k)detectedDistrict=k[1];}
    if(!detectedDistrict){const c=(a.county||'').toString().replace(/^‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/,'').replace(/^‡πÄ‡∏Ç‡∏ï/,'').replace(/,/g,'').trim();if(c)detectedDistrict=c;}
    if(detectedProvince||detectedDistrict){info.classList.remove('loading');let p=[];if(detectedDistrict)p.push('‡∏≠.'+detectedDistrict);if(detectedProvince)p.push('‡∏à.'+detectedProvince);val.textContent=p.join(' ¬∑ ');}
    else{info.classList.remove('loading');val.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á';}
  }catch(e){info.classList.remove('loading');val.textContent='‚ö†Ô∏è ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API (‡∏°‡∏µ timeout 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fetchWithTimeout(url,opts={},ms=10000){
  const ctrl=new AbortController();
  const timer=setTimeout(()=>ctrl.abort(),ms);
  return fetch(url,{...opts,signal:ctrl.signal}).finally(()=>clearTimeout(timer));
}
async function apiGet(action,params=''){if(!API_URL)return null;try{const r=await fetchWithTimeout(`${API_URL}?action=${action}${params}`);const j=await r.json();return j.ok?j.data:null;}catch(e){console.log('API error:',e);return null;}}
async function apiPost(action,data){if(!API_URL)return null;try{const r=await fetchWithTimeout(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action,...data})});const j=await r.json();return j.ok?j.data:null;}catch(e){console.log('API error:',e);return null;}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOP CACHE (localStorage 30 ‡∏ô‡∏≤‡∏ó‡∏µ) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCachedShops(){
  try{
    const raw=localStorage.getItem(SHOP_CACHE_KEY);
    if(!raw) return null;
    const {data,ts}=JSON.parse(raw);
    if(Date.now()-ts > SHOP_CACHE_TTL) return null; // ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    return data;
  }catch(e){return null;}
}
function setCachedShops(data){
  try{localStorage.setItem(SHOP_CACHE_KEY,JSON.stringify({data,ts:Date.now()}));}catch(e){}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  salesName=localStorage.getItem('salespin-myname')||'';
  if(!API_URL){document.getElementById('setupLoading').textContent='‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API_URL';return;}

  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢ login ‚Üí ‡πÅ‡∏™‡∏î‡∏á UI ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if(salesName){
    document.getElementById('setupOverlay').classList.add('hidden');
    document.getElementById('salesNameDisplay').textContent='üë§ '+salesName;
    // ‡πÉ‡∏ä‡πâ cache ‡∏Å‡πà‡∏≠‡∏ô
    const cached=getCachedShops();
    if(cached){allShops=cached;renderAll();}
  }else{
    document.getElementById('setupLoading').textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...';
  }

  // ‡πÇ‡∏´‡∏•‡∏î API ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  const team=await apiGet('getTeam');
  if(team&&team.length){
    salesTeam=team;document.getElementById('connDot').classList.add('ok');
    if(salesName&&salesTeam.includes(salesName)){
      loadAllShops();
    }else if(salesName&&!salesTeam.includes(salesName)){
      salesName='';localStorage.removeItem('salespin-myname');
      populateDropdown();document.getElementById('setupOverlay').classList.remove('hidden');
    }else{
      populateDropdown();
    }
  }else{
    document.getElementById('setupWarning').style.display='block';
    document.getElementById('setupWarning').innerHTML='‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ<br>‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
    document.getElementById('setupLoading').style.display='none';
  }
}

async function loadAllShops(){
  const data=await apiGet('getAllShops');
  if(data){allShops=data;setCachedShops(data);renderAll();}
}

function populateDropdown(){
  const sel=document.getElementById('setupSelect'),ld=document.getElementById('setupLoading'),w=document.getElementById('setupWarning');ld.style.display='none';
  if(!salesTeam.length){w.style.display='block';w.innerHTML='‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô';return;}
  w.style.display='none';sel.style.display='block';document.getElementById('setupBtn').style.display='block';
  sel.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå --</option>';
  salesTeam.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;if(n===salesName)o.selected=true;sel.appendChild(o);});
  if(salesName&&salesTeam.includes(salesName))document.getElementById('setupBtn').disabled=false;
}
function completeSetup(){const v=document.getElementById('setupSelect').value;if(!v)return;salesName=v;localStorage.setItem('salespin-myname',salesName);document.getElementById('setupOverlay').classList.add('hidden');document.getElementById('salesNameDisplay').textContent='üë§ '+salesName;showToast('‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ '+salesName+'!');loadAllShops();}
function showSetup(){populateDropdown();document.getElementById('setupOverlay').classList.remove('hidden');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HAVERSINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function haversine(lat1,lon1,lat2,lon2){const R=6371000,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180,a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GPS ‚Äî ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î + ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function captureGPS(){
  const btn=document.getElementById('gpsBtn');btn.classList.add('loading');btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î...';
  if(!navigator.geolocation){showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS',true);resetGps();return;}
  navigator.geolocation.getCurrentPosition(p=>{
    selectedLat=+p.coords.latitude.toFixed(6);selectedLng=+p.coords.longitude.toFixed(6);
    myLat=selectedLat;myLng=selectedLng;
    updateCoord();placeTempPin(selectedLat,selectedLng);map.setView([selectedLat,selectedLng],16);
    resetGps();reverseGeocode(selectedLat,selectedLng);

    // ‚ïê‚ïê‚ïê ‡∏ï‡∏£‡∏ß‡∏à‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (100 ‡πÄ‡∏°‡∏ï‡∏£) ‚ïê‚ïê‚ïê
    const nearby=allShops.map(s=>({...s,dist:haversine(myLat,myLng,s.lat,s.lng)})).filter(s=>s.dist<=100).sort((a,b)=>a.dist-b.dist);
    if(nearby.length>0){
      showCheckinModal(nearby);
    }else{
      checkReady();showToast('‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)');
    }
  },e=>{
    let msg='';
    switch(e.code){
      case 1:msg='‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á\n‡πÄ‡∏õ‡∏¥‡∏î ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚Üí Location ‚Üí ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ browser';break;
      case 2:msg='‚ö†Ô∏è ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà';break;
      case 3:msg='‚ö†Ô∏è ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‚Äî ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡∏ô';break;
      default:msg='‚ö†Ô∏è ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÅ‡∏ï‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡∏ô';
    }
    showToast(msg,true);resetGps();
  },{enableHighAccuracy:true,timeout:15000});
}
function resetGps(){const b=document.getElementById('gpsBtn');b.classList.remove('loading');b.textContent='üì° ‡∏à‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHECK-IN MODAL ‚Äî ‡πÅ‡∏™‡∏î‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏≤‡∏° ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô? ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingCheckinShops=[];

function showCheckinModal(nearbyShops){
  pendingCheckinShops=nearbyShops;
  const el=document.getElementById('checkinShopList');
  el.innerHTML=nearbyShops.slice(0,5).map(s=>{
    let info=[];
    if(s.district)info.push('‡∏≠.'+s.district);
    if(s.sales)info.push('üë§ '+s.sales);
    return `<div class="checkin-shop-card" onclick="doCheckin('${s.id}')">
      <div class="csc-name">${s.name}</div>
      <div class="csc-info">${info.join(' ¬∑ ')}</div>
      <div class="csc-dist">üìè ${Math.round(s.dist)} ‡πÄ‡∏°‡∏ï‡∏£ ‚Äî ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>
    </div>`;
  }).join('');
  document.getElementById('checkinModal').classList.add('show');
}
function closeCheckinModal(){document.getElementById('checkinModal').classList.remove('show');}

// ‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" ‚Üí ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏•‡πâ‡∏ß flow ‡∏õ‡∏Å‡∏ï‡∏¥
function proceedAddNew(){
  checkReady();
  showToast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ & ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
}

// ‡∏Å‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô ‚Üí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô (‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ)
function doCheckin(shopId){
  const shop=allShops.find(s=>s.id===shopId);
  if(!shop)return;
  closeCheckinModal();

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.capture='environment';
  inp.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=new Image();
      img.onload=()=>{
        // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ overlay (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏° + "‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô" label)
        drawOverlay(img,{...shop,isCheckin:true});

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å checkin ‡∏•‡∏á Sheet
        const checkinData={
          shopId:shop.id,shopName:shop.name,sales:salesName,
          lat:myLat||shop.lat,lng:myLng||shop.lng,
          province:shop.province,district:shop.district,
          checkinAt:new Date().toISOString()
        };
        apiPost('addCheckin',{data:checkinData}).then(r=>{
          if(!r)showToast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',true);
        });

        lastPhotoShop=shop;
        showPhotoModal(shop,true);
      };
      img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

function updateCoord(){const el=document.getElementById('coordDisplay'),tx=document.getElementById('coordText');if(selectedLat!==null){el.classList.add('has-value');tx.classList.remove('empty');tx.innerHTML=`${selectedLat}, ${selectedLng} <span style="color:var(--green)">‚úì</span>`;}else{el.classList.remove('has-value');tx.classList.add('empty');tx.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î';document.getElementById('locationInfo').classList.remove('show');}}
function checkReady(){document.getElementById('saveBtn').disabled=!(selectedLat!==null&&document.getElementById('fName').value.trim());}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE ‚Äî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onSavePhoto(e){
  const file=e.target.files[0];if(!file){e.target.value='';return;}
  if(!selectedLat||!document.getElementById('fName').value.trim()){showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô',true);e.target.value='';return;}

  const shop={
    id:Date.now().toString(36)+Math.random().toString(36).substr(2,5),
    name:document.getElementById('fName').value.trim(),
    lat:selectedLat,lng:selectedLng,
    province:detectedProvince,district:detectedDistrict,
    sales:salesName,
    phone:document.getElementById('fPhone').value.trim(),
    note:document.getElementById('fNote').value.trim(),
    createdAt:new Date().toISOString()
  };

  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      drawOverlay(img,shop);

      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô local + cache
      allShops.unshift(shop);setCachedShops(allShops);renderAll();
      map.setView([shop.lat,shop.lng],14);

      // Clear form
      document.getElementById('fName').value='';document.getElementById('fPhone').value='';document.getElementById('fNote').value='';
      selectedLat=null;selectedLng=null;detectedProvince='';detectedDistrict='';updateCoord();document.getElementById('saveBtn').disabled=true;
      if(tempMarker){map.removeLayer(tempMarker);tempMarker=null;}

      apiPost('addShop',{data:shop}).then(r=>{if(!r)showToast('‚ö†Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',true);});

      lastPhotoShop=shop;
      showPhotoModal(shop,false);
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value='';
}

// ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
function retakeShopPhoto(id){
  const shop=allShops.find(s=>s.id===id);if(!shop)return;
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.capture='environment';
  inp.onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=new Image();
      img.onload=()=>{drawOverlay(img,shop);lastPhotoShop=shop;showPhotoModal(shop,false);};
      img.src=ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DRAW OVERLAY ON PHOTO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawOverlay(img,shop){
  const canvas=document.getElementById('camCanvas'),ctx=canvas.getContext('2d');
  let w=img.width,h=img.height;const maxW=1200;
  if(w>maxW){h=Math.round(h*(maxW/w));w=maxW;}
  canvas.width=w;canvas.height=h;
  ctx.drawImage(img,0,0,w,h);

  const lines=[];
  if(shop.isCheckin) lines.push('‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô');
  lines.push(shop.name);
  if(shop.district||shop.province){let loc=[];if(shop.district)loc.push('‡∏≠.'+shop.district);if(shop.province)loc.push('‡∏à.'+shop.province);lines.push(loc.join(' '));}
  lines.push(parseFloat(shop.lat).toFixed(6)+', '+parseFloat(shop.lng).toFixed(6));
  const now=new Date();
  lines.push(now.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'numeric'})+' '+now.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}));
  lines.push('‡πÄ‡∏ã‡∏•‡∏•‡πå: '+salesName);

  const fs=Math.max(14,Math.round(w*0.03));
  const lineH=fs*1.55;
  const padX=fs*0.9,padY=fs*0.7;
  ctx.font='600 '+fs+'px sans-serif';
  let maxTW=0;lines.forEach(l=>{const m=ctx.measureText(l).width;if(m>maxTW)maxTW=m;});
  const boxW=maxTW+padX*2;
  const boxH=lines.length*lineH+padY*2;
  const boxX=12,boxY=h-boxH-12;

  ctx.fillStyle='rgba(0,0,0,0.7)';ctx.beginPath();roundRect(ctx,boxX,boxY,boxW,boxH,10);ctx.fill();
  // ‡∏™‡∏µ‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≤‡∏á ‚Äî ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô, ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
  ctx.fillStyle=shop.isCheckin?'#34d399':'#4f8cff';ctx.beginPath();roundRect(ctx,boxX,boxY,4,boxH,2);ctx.fill();

  ctx.textBaseline='top';
  lines.forEach((line,i)=>{
    const lineIdx=shop.isCheckin?i:i; // offset for checkin label
    if(shop.isCheckin&&i===0){ctx.fillStyle='#34d399';ctx.font='700 '+(fs*1.1)+'px sans-serif';}
    else if((!shop.isCheckin&&i===0)||(shop.isCheckin&&i===1)){ctx.fillStyle='#ffffff';ctx.font='700 '+(fs*1.15)+'px sans-serif';}
    else if((!shop.isCheckin&&i===1)||(shop.isCheckin&&i===2)){ctx.fillStyle='#4f8cff';ctx.font='600 '+fs+'px sans-serif';}
    else{ctx.fillStyle='rgba(255,255,255,0.8)';ctx.font='500 '+(fs*0.9)+'px sans-serif';}
    ctx.fillText(line,boxX+padX,boxY+padY+i*lineH);
  });
}
function roundRect(ctx,x,y,w,h,r){ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.quadraticCurveTo(x+w,y,x+w,y+r);ctx.lineTo(x+w,y+h-r);ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);ctx.lineTo(x+r,y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PHOTO MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPhotoModal(shop,isCheckin){
  const canvas=document.getElementById('camCanvas');
  document.getElementById('photoModalImg').src=canvas.toDataURL('image/jpeg',0.85);
  let info=isCheckin?`‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô "${shop.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`:`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "${shop.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
  if(shop.district)info+=`<br>üìç ‡∏≠.${shop.district}`;
  if(shop.province)info+=` ‡∏à.${shop.province}`;
  document.getElementById('photoModalInfo').innerHTML=info;
  document.getElementById('photoModal').classList.add('show');
}
function closePhotoModal(){document.getElementById('photoModal').classList.remove('show');}

async function shareCurrentPhoto(){
  const canvas=document.getElementById('camCanvas');
  const shop=lastPhotoShop;
  const fileName=(shop?shop.name:'photo')+'_'+new Date().toISOString().slice(0,10)+'.jpg';
  if(navigator.share){
    try{
      const blob=await new Promise(r=>canvas.toBlob(r,'image/jpeg',0.85));
      const file=new File([blob],fileName,{type:'image/jpeg'});
      if(navigator.canShare&&navigator.canShare({files:[file]})){await navigator.share({files:[file]});closePhotoModal();showToast('‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');return;}
    }catch(e){if(e.name==='AbortError')return;}
  }
  const link=document.createElement('a');link.download=fileName;link.href=canvas.toDataURL('image/jpeg',0.85);
  document.body.appendChild(link);link.click();document.body.removeChild(link);
  showToast('üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å Gallery ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÉ‡∏ô LINE');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MARKERS (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 100 ‡πÄ‡∏°‡∏ï‡∏£) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pinIcon(isMine){return L.divIcon({className:'',html:`<div class="custom-pin${isMine?' mine':''}"></div>`,iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24]})}
function placeTempPin(lat,lng){if(tempMarker)map.removeLayer(tempMarker);tempMarker=L.marker([lat,lng],{icon:L.divIcon({className:'',html:'<div class="custom-pin temp"></div>',iconSize:[24,24],iconAnchor:[12,24]})}).addTo(map)}
function renderMarkers(){
  Object.values(markers).forEach(m=>map.removeLayer(m));markers={};
  if(myLat===null) return; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ GPS
  allShops.forEach(s=>{
    const dist=haversine(myLat,myLng,s.lat,s.lng);
    if(dist>100) return; // ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 100 ‡πÄ‡∏°‡∏ï‡∏£
    const isMine=s.sales===salesName;
    const m=L.marker([s.lat,s.lng],{icon:pinIcon(isMine)}).addTo(map);
    let locLine='';if(s.district||s.province){let p=[];if(s.district)p.push('‡∏≠.'+s.district);if(s.province)p.push('‡∏à.'+s.province);locLine='üìç '+p.join(' ')+'<br>';}
    m.bindPopup(`<div style="font-weight:600">${s.name}</div><div style="color:var(--text-dim);font-size:12px;margin-top:4px">${locLine}üë§ ${s.sales||'-'}<br>${s.phone?'üìû '+s.phone+'<br>':''}${s.note?'üìù '+s.note:''}</div><a href="https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}" target="_blank" style="color:var(--blue);font-size:12px;text-decoration:none">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>`);
    markers[s.id]=m;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SHOP LIST (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 100 ‡πÄ‡∏°‡∏ï‡∏£) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderShops(){
  const el=document.getElementById('shopsList');
  const status=document.getElementById('nearbyStatus');

  if(myLat===null){
    status.innerHTML='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
    el.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-dim);font-size:13px">üì° ‡∏£‡∏≠‡∏à‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS...</div>';
    return;
  }

  const q=(document.getElementById('searchInput').value||'').toLowerCase();
  let list=allShops.map(s=>({...s,dist:haversine(myLat,myLng,s.lat,s.lng)})).filter(s=>s.dist<=100).sort((a,b)=>a.dist-b.dist);
  if(q) list=list.filter(s=>s.name.toLowerCase().includes(q)||(s.phone||'').includes(q));

  status.innerHTML=`üì° ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‚Äî ‡∏û‡∏ö <span class="count">${list.length}</span> ‡∏£‡πâ‡∏≤‡∏ô‡πÉ‡∏ô 100 ‡πÄ‡∏°‡∏ï‡∏£`;

  if(!list.length){el.innerHTML=`<div style="text-align:center;padding:24px;color:var(--text-dim);font-size:13px">${q?'üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤':'üìç ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞ 100 ‡πÄ‡∏°‡∏ï‡∏£'}</div>`;return;}
  el.innerHTML=list.map(s=>{
    const d=new Date(s.createdAt).toLocaleDateString('th-TH',{day:'numeric',month:'short'});
    let loc='';if(s.district||s.province){let p=[];if(s.district)p.push('‡∏≠.'+s.district);if(s.province)p.push('‡∏à.'+s.province);loc=p.join(' ¬∑ ');}
    const isMine=s.sales===salesName;
    const ownerBadge=`<span class="shop-item-owner${isMine?' mine':''}">${s.sales||'-'}</span>`;
    return `<div class="shop-item" onclick="focusShop('${s.id}')">
      <div class="shop-item-name">${s.name} ${ownerBadge}</div>
      ${loc?`<div class="shop-item-loc">üìç ${loc}</div>`:''}
      <div class="shop-item-meta"><span class="shop-item-dist">üìè ${Math.round(s.dist)} ‡∏°.</span> ¬∑ ${s.phone?'üìû '+s.phone+' ¬∑ ':''}${d}</div>
      <div class="shop-item-actions">
        <button class="mini-btn nav-btn" onclick="event.stopPropagation();openNav('${s.id}')">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
        <button class="mini-btn cam-btn" onclick="event.stopPropagation();retakeShopPhoto('${s.id}')">üì∑ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
      </div>
    </div>`;}).join('');
}
function focusShop(id){const s=allShops.find(x=>x.id===id);if(s){map.setView([s.lat,s.lng],16);if(markers[id])markers[id].openPopup();}}
function openNav(id){const s=allShops.find(x=>x.id===id);if(s)window.open(`https://www.google.com/maps/dir/?api=1&destination=${s.lat},${s.lng}`,'_blank');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UPDATE GPS WHEN SWITCHING TO SHOPS TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateMyPosition(){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(p=>{
    myLat=+p.coords.latitude.toFixed(6);myLng=+p.coords.longitude.toFixed(6);
    renderMarkers();renderShops();
    map.setView([myLat,myLng],16);
  },e=>{
    document.getElementById('nearbyStatus').innerHTML='‚ö†Ô∏è ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äî ‡πÄ‡∏õ‡∏¥‡∏î GPS ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
  },{enableHighAccuracy:true,timeout:15000});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchScreen(name){
  ['pin','shops'].forEach(s=>document.getElementById('screen'+s[0].toUpperCase()+s.slice(1)).classList.toggle('active',s===name));
  document.querySelectorAll('.nav-item').forEach((el,i)=>el.classList.toggle('active',(name==='pin'&&i===0)||(name==='shops'&&i===1)));
  document.getElementById('mapHint').classList.toggle('show',name==='pin');
  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‚Üí ‡∏à‡∏±‡∏ö GPS ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  if(name==='shops') updateMyPosition();
}
function renderAll(){renderMarkers();renderShops();}
function showToast(msg,isErr){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(isErr?' error':'');setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),3500);}

init();setTimeout(()=>map.invalidateSize(),150);
</script>
</body>
</html>
