<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Map Admin - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0d13;--surface:#12151e;--surface2:#1a1e2c;--surface3:#222738;--border:#272d42;--border-light:#333a54;--text:#e8eaf2;--text-dim:#6e7590;--text-mid:#9aa0b8;--blue:#4f8cff;--blue-bg:rgba(79,140,255,0.08);--blue-border:rgba(79,140,255,0.25);--green:#34d399;--green-bg:rgba(52,211,153,0.08);--orange:#fbbf24;--orange-bg:rgba(251,191,36,0.08);--red:#f87171;--red-bg:rgba(248,113,113,0.08);--purple:#a78bfa;--radius:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'IBM Plex Sans Thai',sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

.header{background:var(--surface);border-bottom:1px solid var(--border);padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between}
.header-left{display:flex;align-items:center;gap:12px}
.logo-mark{width:32px;height:32px;background:linear-gradient(135deg,var(--blue),#7c5cfc);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.header h1{font-size:15px;font-weight:600}
.header h1 small{font-weight:400;color:var(--text-dim);font-size:11px;margin-left:8px}
.conn-status{font-size:11px;padding:4px 10px;border-radius:12px;border:1px solid var(--border);color:var(--text-dim)}
.conn-status.ok{border-color:var(--green);color:var(--green)}
.conn-status.err{border-color:var(--red);color:var(--red)}
.header-actions{display:flex;align-items:center;gap:8px}
.h-btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:500;font-family:inherit;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text-mid);transition:all 0.15s;display:flex;align-items:center;gap:5px}
.h-btn:hover{border-color:var(--blue);color:var(--blue)}
.h-btn.primary{background:var(--blue);color:white;border-color:var(--blue)}
.h-btn.primary:hover{filter:brightness(1.1)}
.h-btn.danger:hover{border-color:var(--red);color:var(--red)}
.h-btn:disabled{opacity:0.4;pointer-events:none}

.layout{display:flex;height:calc(100vh - 54px)}
.table-panel{flex:1;display:flex;flex-direction:column;min-width:0}
.stats-strip{display:flex;gap:1px;background:var(--border);border-bottom:1px solid var(--border)}
.stat-card{flex:1;background:var(--surface);padding:14px 18px}
.stat-label{font-size:11px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
.stat-value{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}
.stat-value.blue{color:var(--blue)}.stat-value.green{color:var(--green)}.stat-value.orange{color:var(--orange)}.stat-value.purple{color:var(--purple)}

.toolbar{padding:10px 16px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);background:var(--surface);flex-wrap:wrap}
.tool-input,.tool-select{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:7px 12px;border-radius:8px;font-size:12px;font-family:inherit;outline:none}
.tool-input{min-width:180px}.tool-select{min-width:110px}
.tool-input:focus,.tool-select:focus{border-color:var(--blue)}
.tool-sep{width:1px;height:24px;background:var(--border)}
.selection-info{font-size:12px;color:var(--text-dim);margin-left:auto}
.selection-info b{color:var(--blue)}
.date-filter-group{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.date-preset{padding:5px 10px;border-radius:6px;font-size:11px;font-weight:500;font-family:inherit;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);transition:all 0.15s;white-space:nowrap}
.date-preset:hover{border-color:var(--blue-border);color:var(--text-mid)}
.date-preset.active{background:var(--blue-bg);border-color:var(--blue);color:var(--blue)}
.date-sep{color:var(--text-dim);font-size:11px}
.date-input{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:6px;font-size:11px;font-family:inherit;outline:none;width:130px;color-scheme:dark}
.date-input:focus{border-color:var(--blue)}
.date-clear{padding:4px 8px;border-radius:6px;font-size:11px;font-family:inherit;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);transition:all 0.15s}
.date-clear:hover{border-color:var(--red);color:var(--red)}

.table-wrap{flex:1;overflow:auto}
.table-wrap::-webkit-scrollbar{width:6px;height:6px}
.table-wrap::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
table{width:100%;border-collapse:collapse;font-size:13px}
thead{position:sticky;top:0;z-index:10}
th{background:var(--surface2);padding:10px 12px;text-align:left;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-dim);border-bottom:1px solid var(--border);white-space:nowrap;cursor:pointer;user-select:none}
th:hover{color:var(--text)}
td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
tr{transition:background 0.1s}
tr:hover td{background:var(--blue-bg)}
tr.selected td{background:rgba(79,140,255,0.12)}
.cb-cell{width:36px;text-align:center}
.cb-cell input{cursor:pointer;accent-color:var(--blue);width:15px;height:15px}
.cell-name{font-weight:600}
.cell-loc{display:inline-block;background:var(--surface3);padding:2px 8px;border-radius:6px;font-size:11px;color:var(--text-mid)}
.cell-sales{color:var(--purple);font-weight:500}
.cell-coord{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-dim)}
.cell-date{font-size:12px;color:var(--text-dim)}
.row-actions{display:flex;gap:4px}
.row-btn{padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);font-size:11px;cursor:pointer;font-family:inherit}
.row-btn:hover{border-color:var(--blue);color:var(--blue)}
.row-btn.del:hover{border-color:var(--red);color:var(--red)}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-dim);font-size:14px}

.right-panel{width:440px;min-width:440px;border-left:1px solid var(--border);display:flex;flex-direction:column}
.right-tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border)}
.right-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:500;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
.right-tab.active{color:var(--blue);border-bottom-color:var(--blue)}
.right-tab:hover{color:var(--text)}
.right-content{flex:1;display:flex;flex-direction:column;overflow:hidden}
.right-screen{display:none;flex:1;flex-direction:column;overflow:hidden}
.right-screen.active{display:flex}
#adminMap{flex:1}

.settings-content{flex:1;overflow-y:auto;padding:20px}
.settings-content::-webkit-scrollbar{width:4px}
.settings-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.settings-section{margin-bottom:24px}
.settings-section-title{font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.settings-section-desc{font-size:12px;color:var(--text-dim);margin-bottom:14px;line-height:1.5}
.add-sales-row{display:flex;gap:8px;margin-bottom:14px}
.add-sales-input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 14px;border-radius:8px;font-size:13px;font-family:inherit;outline:none}
.add-sales-input:focus{border-color:var(--blue)}
.add-sales-btn{padding:9px 16px;background:var(--blue);border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;white-space:nowrap}
.add-sales-btn:hover{filter:brightness(1.1)}
.add-sales-btn:disabled{opacity:0.3;pointer-events:none}
.sales-team-list{display:flex;flex-direction:column;gap:6px}
.team-member-card{display:flex;align-items:center;gap:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:10px 14px}
.member-avatar{width:34px;height:34px;border-radius:50%;background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.member-info{flex:1}
.member-name{font-size:13px;font-weight:600}
.member-stats{font-size:11px;color:var(--text-dim)}
.member-remove{padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text-dim);font-size:11px;cursor:pointer;font-family:inherit;transition:all 0.15s}
.member-remove:hover{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.empty-team{text-align:center;padding:30px;color:var(--text-dim);font-size:13px;background:var(--bg);border:1px dashed var(--border);border-radius:10px}

/* ‚ïê‚ïê EXPORT FULL-SCREEN OVERLAY (warm tone) ‚ïê‚ïê */
.export-overlay{display:none;position:fixed;inset:0;z-index:4000;background:#0d0f08;flex-direction:column}
.export-overlay.show{display:flex}
.export-overlay .ex-header{background:#1a1d10;border-bottom:1px solid #2e3318;padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.export-overlay .ex-header-left{display:flex;align-items:center;gap:12px}
.export-overlay .ex-logo{width:32px;height:32px;background:linear-gradient(135deg,#f59e0b,#ea580c);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.export-overlay .ex-header h2{font-size:15px;font-weight:600;color:#f5f0e0}
.export-overlay .ex-header h2 small{font-weight:400;color:#8a8060;font-size:11px;margin-left:8px}
.ex-h-btn{padding:7px 14px;border-radius:8px;font-size:12px;font-weight:500;font-family:inherit;cursor:pointer;border:1px solid #2e3318;background:#1e2212;color:#8a8060;transition:all 0.15s;display:flex;align-items:center;gap:5px}
.ex-h-btn:hover{border-color:#f59e0b;color:#f59e0b}
.ex-h-btn.primary{background:#f59e0b;color:#0d0f08;border-color:#f59e0b;font-weight:700}
.ex-h-btn.primary:hover{filter:brightness(1.1)}
.ex-h-btn.primary:disabled{opacity:0.3;pointer-events:none}

.ex-body{display:flex;flex:1;overflow:hidden}

/* ‚ïê LEFT PANEL ‚ïê */
.ex-left{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.ex-left-head{padding:12px 16px;background:#14170c;border-bottom:1px solid #2e3318;font-size:13px;font-weight:700;color:#c8b870;display:flex;align-items:center;justify-content:space-between}
.ex-count-badge{font-size:11px;padding:3px 12px;border-radius:12px;border:1px solid #f59e0b;color:#f59e0b;font-weight:600;background:rgba(245,158,11,0.08)}
.ex-count-badge.selected{border-color:#34d399;color:#34d399;background:rgba(52,211,153,0.08)}

.export-overlay .ex-toolbar{padding:8px 12px;display:flex;align-items:center;gap:6px;border-bottom:1px solid #2e3318;background:#14170c;flex-wrap:wrap}
.ex-tool-input,.ex-tool-select{background:#0d0f08;border:1px solid #2e3318;color:#f5f0e0;padding:6px 10px;border-radius:7px;font-size:11px;font-family:inherit;outline:none}
.ex-tool-input{min-width:160px}
.ex-tool-select{min-width:100px}
.ex-tool-input:focus,.ex-tool-select:focus{border-color:#f59e0b}
.ex-tool-sep{width:1px;height:20px;background:#2e3318}
.ex-date-input{background:#0d0f08;border:1px solid #2e3318;color:#f5f0e0;padding:5px 8px;border-radius:6px;font-size:11px;font-family:inherit;outline:none;width:120px;color-scheme:dark}
.ex-date-input:focus{border-color:#f59e0b}
.ex-date-sep{color:#8a8060;font-size:11px}
.ex-date-clear{padding:4px 8px;border-radius:6px;font-size:11px;font-family:inherit;cursor:pointer;border:1px solid #2e3318;background:#1e2212;color:#8a8060}
.ex-date-clear:hover{border-color:#ea580c;color:#ea580c}
.ex-add-all-btn{padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid rgba(245,158,11,0.3);background:rgba(245,158,11,0.08);color:#f59e0b;transition:all 0.15s;white-space:nowrap}
.ex-add-all-btn:hover{background:#f59e0b;color:#0d0f08}

.ex-table-wrap{flex:1;overflow:auto}
.ex-table-wrap::-webkit-scrollbar{width:6px;height:6px}
.ex-table-wrap::-webkit-scrollbar-thumb{background:#2e3318;border-radius:3px}
.export-overlay table{width:100%;border-collapse:collapse;font-size:12px}
.export-overlay thead{position:sticky;top:0;z-index:10}
.export-overlay th{background:#1e2212;padding:9px 10px;text-align:left;font-weight:600;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:#8a8060;border-bottom:1px solid #2e3318;white-space:nowrap;user-select:none}
.export-overlay td{padding:8px 10px;border-bottom:1px solid #1a1d10;white-space:nowrap;color:#c8c0a8}
.export-overlay tr:hover td{background:rgba(245,158,11,0.06)}
.export-overlay tr.ex-selected td{background:rgba(245,158,11,0.12)}
.export-overlay .cb-cell{width:32px;text-align:center}
.export-overlay .cb-cell input{cursor:pointer;accent-color:#f59e0b;width:14px;height:14px}
.export-overlay .ex-cell-name{font-weight:600;color:#f5f0e0}
.export-overlay .ex-cell-loc{display:inline-block;background:#1e2212;padding:2px 7px;border-radius:5px;font-size:10px;color:#a89e80}
.export-overlay .ex-cell-sales{color:#f59e0b;font-weight:500}
.export-overlay .ex-cell-coord{font-family:'JetBrains Mono',monospace;font-size:10px;color:#6a6248}
.export-overlay .ex-cell-date{font-size:11px;color:#6a6248}
.export-overlay .ex-empty{text-align:center;padding:50px 20px;color:#6a6248;font-size:13px}

/* ‚ïê RIGHT PANEL ‚ïê */
.ex-right{width:340px;min-width:340px;border-left:2px solid #3d4420;display:flex;flex-direction:column;background:#11140a}
.ex-right-head{padding:12px 16px;background:#1a1d10;border-bottom:1px solid #2e3318;font-size:13px;font-weight:700;color:#34d399;display:flex;align-items:center;justify-content:space-between}
.ex-right-toolbar{padding:8px 12px;border-bottom:1px solid #2e3318;display:flex;gap:6px;align-items:center}
.ex-clear-btn{padding:5px 10px;border-radius:6px;font-size:11px;font-weight:500;font-family:inherit;cursor:pointer;border:1px solid #2e3318;background:#1e2212;color:#8a8060;white-space:nowrap}
.ex-clear-btn:hover{border-color:#f87171;color:#f87171}
.ex-right-list{flex:1;overflow-y:auto;padding:6px}
.ex-right-list::-webkit-scrollbar{width:4px}
.ex-right-list::-webkit-scrollbar-thumb{background:#2e3318;border-radius:3px}
.ex-right-item{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;margin:2px 0;transition:all 0.1s;cursor:pointer}
.ex-right-item:hover{background:rgba(248,113,113,0.08)}
.ex-right-item-name{font-weight:600;font-size:12px;color:#f5f0e0;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ex-right-item-sub{font-size:10px;color:#8a8060;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ex-right-item-remove{font-size:10px;color:#f87171;padding:2px 8px;border:1px solid rgba(248,113,113,0.25);border-radius:5px;flex-shrink:0;transition:all 0.15s}
.ex-right-item:hover .ex-right-item-remove{background:#f87171;color:white;border-color:#f87171}
.ex-right-empty{text-align:center;padding:40px 16px;color:#6a6248;font-size:12px;line-height:1.8}
.ex-right-footer{padding:12px;border-top:1px solid #2e3318;display:flex;flex-direction:column;gap:8px}
.ex-right-summary{font-size:11px;color:#8a8060;text-align:center;line-height:1.6}
.ex-right-summary b{color:#f59e0b}
.ex-export-btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;background:linear-gradient(135deg,#f59e0b,#ea580c);color:#0d0f08;transition:all 0.15s;box-shadow:0 4px 16px rgba(245,158,11,0.2)}
.ex-export-btn:hover{filter:brightness(1.1)}
.ex-export-btn:disabled{opacity:0.25;pointer-events:none;box-shadow:none}

.api-url-row{display:flex;gap:8px}
.api-url-input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:9px 14px;border-radius:8px;font-size:12px;font-family:'JetBrains Mono',monospace;outline:none}
.api-url-input:focus{border-color:var(--blue)}

.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:5000;align-items:center;justify-content:center}
.modal-bg.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;width:480px;max-height:80vh;overflow-y:auto}
.modal h2{font-size:16px;margin-bottom:16px}
.modal .form-group{margin-bottom:12px}
.modal .form-group label{display:block;font-size:11px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase;letter-spacing:0.3px}
.modal .form-group input,.modal .form-group select,.modal .form-group textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:8px;font-size:13px;font-family:inherit;outline:none}
.modal .form-group textarea{resize:vertical;min-height:50px}
.modal .form-group input:focus,.modal .form-group select:focus{border-color:var(--blue)}
.modal-row{display:flex;gap:10px}
.modal-row .form-group{flex:1}
.modal-footer{display:flex;gap:8px;margin-top:18px}
.modal-footer button{flex:1;padding:10px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;font-family:inherit;border:1px solid var(--border)}
.m-cancel{background:var(--surface2);color:var(--text)}
.m-save{background:var(--blue);color:white;border-color:var(--blue)!important}
.import-zone{border:2px dashed var(--border);border-radius:12px;padding:30px;text-align:center;color:var(--text-dim);margin-bottom:12px;cursor:pointer;transition:all 0.2s}
.import-zone:hover{border-color:var(--blue);color:var(--blue)}
.import-zone input{display:none}

.geocode-check{margin-top:12px;padding:10px;background:var(--blue-bg);border:1px solid var(--blue-border);border-radius:8px;font-size:12px;color:var(--blue);display:flex;align-items:center;gap:8px}
.geocode-check input{accent-color:var(--blue);width:16px;height:16px}
.import-progress{margin-top:10px;font-size:12px;color:var(--orange)}
.progress-bar{width:100%;height:4px;background:var(--surface3);border-radius:2px;margin-top:6px;overflow:hidden}
.progress-bar-fill{height:100%;background:var(--blue);border-radius:2px;transition:width 0.3s}

.toast{position:fixed;bottom:20px;right:20px;background:var(--surface);border:1px solid var(--green);color:var(--green);padding:10px 20px;border-radius:10px;font-size:13px;z-index:9999;transform:translateY(80px);transition:transform 0.3s;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.toast.error{border-color:var(--red);color:var(--red)}
.toast.show{transform:translateY(0)}

.leaflet-popup-content-wrapper{background:var(--surface)!important;color:var(--text)!important;border-radius:10px!important;border:1px solid var(--border)!important;box-shadow:0 8px 30px rgba(0,0,0,0.5)!important}
.leaflet-popup-tip{background:var(--surface)!important}
.leaflet-popup-content{margin:10px 14px!important;font-family:'IBM Plex Sans Thai',sans-serif!important;font-size:13px!important}
.admin-pin{width:22px;height:22px;background:var(--blue);border:2px solid white;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 2px 6px rgba(0,0,0,0.3)}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <div class="logo-mark">üìç</div>
    <h1>Sales Map Admin <small>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</small></h1>
    <span class="conn-status" id="connStatus">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
  </div>
  <div class="header-actions">
    <button class="h-btn" id="refreshBtn" onclick="refreshData()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    <button class="h-btn" onclick="showImportModal()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV</button>
    <button class="h-btn" onclick="openExportPage()">üì¶ Export</button>
    <button class="h-btn primary" onclick="showAddModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô</button>
  </div>
</div>

<div class="layout">
  <div class="table-panel">
    <div class="stats-strip">
      <div class="stat-card"><div class="stat-label">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-value blue" id="statTotal">-</div></div>
      <div class="stat-card"><div class="stat-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</div><div class="stat-value green" id="statProvince">-</div></div>
      <div class="stat-card"><div class="stat-label">‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-value purple" id="statSales">-</div></div>
      <div class="stat-card"><div class="stat-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-value orange" id="statMonth">-</div></div>
    </div>
    <div class="toolbar">
      <input class="tool-input" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." oninput="renderTable()">
      <select class="tool-select" id="filterProv" onchange="renderTable()"><option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option></select>
      <select class="tool-select" id="filterDistrict" onchange="renderTable()"><option value="">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option></select>
      <select class="tool-select" id="filterSales" onchange="renderTable()"><option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option></select>
      <div class="tool-sep"></div>
      <div class="date-filter-group">
        <button class="date-preset" onclick="setDatePreset('today',this)">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
        <button class="date-preset" onclick="setDatePreset('week',this)">7 ‡∏ß‡∏±‡∏ô</button>
        <button class="date-preset" onclick="setDatePreset('month',this)">30 ‡∏ß‡∏±‡∏ô</button>
        <span class="date-sep">‚îÇ</span>
        <input type="date" class="date-input" id="dateFrom" onchange="onDateChange()" title="‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà">
        <span class="date-sep">‡∏ñ‡∏∂‡∏á</span>
        <input type="date" class="date-input" id="dateTo" onchange="onDateChange()" title="‡∏ñ‡∏∂‡∏á">
        <button class="date-clear" id="dateClearBtn" onclick="clearDateFilter()" style="display:none">‚úï</button>
      </div>
      <div class="tool-sep"></div>
      <div class="selection-info" id="selectionInfo"></div>
    </div>
    <div class="table-wrap">
      <table><thead><tr>
        <th class="cb-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
        <th onclick="sortBy('name')">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th>
        <th onclick="sortBy('province')">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
        <th onclick="sortBy('district')">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
        <th onclick="sortBy('sales')">‡πÄ‡∏ã‡∏•‡∏•‡πå</th>
        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th>
        <th onclick="sortBy('createdAt')">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr></thead><tbody id="tableBody"></tbody></table>
    </div>
  </div>

  <div class="right-panel">
    <div class="right-tabs">
      <div class="right-tab active" onclick="switchRight('map')">üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
      <div class="right-tab" onclick="switchRight('settings')">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
    </div>
    <div class="right-content">
      <div class="right-screen active" id="rightMap"><div id="adminMap"></div></div>

      <div class="right-screen" id="rightSettings">
        <div class="settings-content">
          <div class="settings-section">
            <div class="settings-section-title">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</div>
            <div class="settings-section-desc">‡∏ß‡∏≤‡∏á URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</div>
            <div class="api-url-row">
              <input class="api-url-input" id="apiUrlInput" placeholder="https://script.google.com/macros/s/xxxxx/exec">
              <button class="add-sales-btn" onclick="saveApiUrl()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-section-title">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå</div>
            <div class="settings-section-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ Sales Pin</div>
            <div class="add-sales-row">
              <input class="add-sales-input" id="newSalesName" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÉ‡∏´‡∏°‡πà..." oninput="document.getElementById('addSalesBtn').disabled=!this.value.trim()" onkeydown="if(event.key==='Enter')addSalesMember()">
              <button class="add-sales-btn" id="addSalesBtn" disabled onclick="addSalesMember()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <div class="sales-team-list" id="salesTeamList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-bg" id="editModal"><div class="modal">
  <h2 id="modalTitle">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
  <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label><input id="mName"></div>
  <div class="modal-row">
    <div class="form-group"><label>‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î</label><input id="mLat" type="number" step="any"></div>
    <div class="form-group"><label>‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î</label><input id="mLng" type="number" step="any"></div>
    <div class="form-group" style="flex:0.6;display:flex;align-items:flex-end"><button class="h-btn" onclick="geocodeModal()" style="width:100%;justify-content:center;padding:9px 8px">üìç ‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á</button></div>
  </div>
  <div class="modal-row">
    <div class="form-group"><label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input id="mProvince" placeholder="‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î"></div>
    <div class="form-group"><label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label><input id="mDistrict" placeholder="‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î"></div>
  </div>
  <div class="modal-row">
    <div class="form-group"><label>‡πÄ‡∏ã‡∏•‡∏•‡πå</label><select id="mSales"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option></select></div>
    <div class="form-group"><label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label><input id="mPhone"></div>
  </div>
  <div class="form-group"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="mNote"></textarea></div>
  <div class="modal-footer"><button class="m-cancel" onclick="closeModal('editModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="m-save" onclick="saveModal()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
</div></div>

<!-- IMPORT MODAL -->
<div class="modal-bg" id="importModal"><div class="modal">
  <h2>üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CSV</h2>
  <div class="import-zone" onclick="document.getElementById('csvFile').click()">
    <div style="font-size:32px;margin-bottom:8px">üìÑ</div>
    <div>‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</div>
    <div style="font-size:11px;margin-top:6px;color:var(--text-dim)">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: name, lat, lng, sales (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</div>
    <div style="font-size:10px;margin-top:4px;color:var(--orange)">üí° ‡∏ñ‡πâ‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å Excel ‡πÉ‡∏´‡πâ Save As ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "CSV UTF-8"</div>
    <input type="file" id="csvFile" accept=".csv" onchange="handleCSV(event)">
  </div>
  <div id="importPreview" style="font-size:12px;color:var(--text-dim);margin-bottom:8px"></div>
  <div class="geocode-check" id="geocodeCheck" style="display:none">
    <input type="checkbox" id="autoGeocode" checked>
    <label for="autoGeocode">‡∏´‡∏≤‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏£‡πâ‡∏≤‡∏ô)</label>
  </div>
  <div class="import-progress" id="importProgress" style="display:none">
    <span id="progressText"></span>
    <div class="progress-bar"><div class="progress-bar-fill" id="progressFill" style="width:0"></div></div>
  </div>
  <div class="modal-footer">
    <button class="m-cancel" id="importCancelBtn" onclick="closeModal('importModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    <button class="m-save" id="importBtn" onclick="doImport()" style="display:none">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
  </div>
</div></div>

<!-- EXPORT FULL-SCREEN OVERLAY -->
<div class="export-overlay" id="exportOverlay">
  <div class="ex-header">
    <div class="ex-header-left">
      <div class="ex-logo">üì¶</div>
      <h2>Export ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ <small>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ ‚Üí ‡∏Å‡∏î Export</small></h2>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <button class="ex-h-btn primary" id="expGoBtn" disabled onclick="doExportSelected()">üì§ Export CSV</button>
      <button class="ex-h-btn" onclick="closeExportPage()">‚úï ‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
  <div class="ex-body">
    <!-- ‚ïê‚ïê‚ïê LEFT: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á + filter ‚ïê‚ïê‚ïê -->
    <div class="ex-left">
      <div class="ex-left-head">
        <span>üìã ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        <div class="ex-count-badge" id="exLeftBadge">0 ‡∏£‡πâ‡∏≤‡∏ô</div>
      </div>
      <div class="ex-toolbar">
        <input class="ex-tool-input" id="exSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£..." oninput="renderExportTable()">
        <select class="ex-tool-select" id="exFilterProv" onchange="onExProvChange();renderExportTable()"><option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option></select>
        <select class="ex-tool-select" id="exFilterDistrict" onchange="renderExportTable()"><option value="">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option></select>
        <select class="ex-tool-select" id="exFilterSales" onchange="renderExportTable()"><option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option></select>
        <div class="ex-tool-sep"></div>
        <input type="date" class="ex-date-input" id="exDateFrom" onchange="renderExportTable()" title="‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà">
        <span class="ex-date-sep">‡∏ñ‡∏∂‡∏á</span>
        <input type="date" class="ex-date-input" id="exDateTo" onchange="renderExportTable()">
        <button class="ex-date-clear" id="exDateClear" onclick="clearExDateFilter()" style="display:none">‚úï</button>
        <div style="margin-left:auto">
          <button class="ex-add-all-btn" onclick="addAllFiltered()">‚äï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á</button>
        </div>
      </div>
      <div class="ex-table-wrap">
        <table><thead><tr>
          <th class="cb-cell"><input type="checkbox" id="exSelectAll" onchange="toggleExSelectAll()"></th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th><th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th><th>‡πÄ‡∏ã‡∏•‡∏•‡πå</th>
          <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡∏û‡∏¥‡∏Å‡∏±‡∏î</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        </tr></thead><tbody id="exTableBody"></tbody></table>
      </div>
    </div>
    <!-- ‚ïê‚ïê‚ïê RIGHT: ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚ïê‚ïê‚ïê -->
    <div class="ex-right">
      <div class="ex-right-head">
        <span>üì¶ ‡∏à‡∏∞ Export</span>
        <div class="ex-count-badge selected" id="exRightBadge">0 ‡∏£‡πâ‡∏≤‡∏ô</div>
      </div>
      <div class="ex-right-toolbar">
        <input class="ex-tool-input" id="exSearchRight" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£..." oninput="renderExportRight()" style="flex:1">
        <button class="ex-clear-btn" onclick="clearExportList()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
      <div class="ex-right-list" id="exRightList"></div>
      <div class="ex-right-footer">
        <div class="ex-right-summary" id="exRightSummary"></div>
        <button class="ex-export-btn" id="expGoBtn2" disabled onclick="doExportSelected()">üì§ Export CSV</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let shops=[],salesTeam=[],selected=new Set(),sortField='createdAt',sortDir=-1,editingId=null,csvRows=[];
let API_URL=localStorage.getItem('salesmap-api-url')||'https://script.google.com/macros/s/AKfycbyWJGCku3wxI0tR0l0CX3RGj7P8OT_ccbTaCVu82Cuqe3tJC4ar7SZDfsuCLO8Yeb8J/exec';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const map=L.map('adminMap',{center:[18.7883,98.9853],zoom:9});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM',maxZoom:19}).addTo(map);
let markers={};
function pinIcon(){return L.divIcon({className:'',html:'<div class="admin-pin"></div>',iconSize:[22,22],iconAnchor:[11,22],popupAnchor:[0,-22]})}
function renderMarkers(){
  Object.values(markers).forEach(m=>map.removeLayer(m));markers={};
  getFiltered().forEach(s=>{
    const m=L.marker([s.lat,s.lng],{icon:pinIcon()}).addTo(map);
    let loc='';if(s.district||s.province){let p=[];if(s.district)p.push('‡∏≠.'+s.district);if(s.province)p.push('‡∏à.'+s.province);loc='üìç '+p.join(' ')+'<br>';}
    m.bindPopup(`<div style="font-weight:600">${s.name}</div><div style="font-size:12px;color:var(--text-dim);margin-top:4px">${loc}${s.sales?'üë§ '+s.sales+'<br>':''}${s.phone?'üìû '+s.phone:''}</div>`);
    markers[s.id]=m;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REVERSE GEOCODING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function reverseGeocode(lat,lng){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=th&addressdetails=1`);
    const j=await r.json();
    const a=j.address||{};
    const dn=j.display_name||'';

    // ‚ïê‚ïê‚ïê ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‚Äî ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å display_name ‡∏Å‡πà‡∏≠‡∏ô ‚ïê‚ïê‚ïê
    let prov='';
    const provMatch=dn.match(/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î([^\s,]+)/);
    if(provMatch) prov=provMatch[1];
    // fallback ‡∏à‡∏≤‡∏Å address fields
    if(!prov) prov=(a.state||a.province||'').toString().replace(/^‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î/,'').replace(/,/g,'').trim();

    // ‚ïê‚ïê‚ïê ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ ‚ïê‚ïê‚ïê
    // ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å display_name ‡∏Å‡πà‡∏≠‡∏ô ‚Äî ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≥‡∏ö‡∏•
    let dist='';
    const distMatch=dn.match(/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠([^\s,]+)/);
    if(distMatch) dist=distMatch[1];
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û ‡πÉ‡∏ä‡πâ "‡πÄ‡∏Ç‡∏ï"
    if(!dist){
      const khetMatch=dn.match(/‡πÄ‡∏Ç‡∏ï([^\s,]+)/);
      if(khetMatch) dist=khetMatch[1];
    }
    // fallback: ‡∏•‡∏≠‡∏á county ‡∏à‡∏≤‡∏Å address (‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠)
    if(!dist){
      const county=(a.county||'').toString().replace(/^‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/,'').replace(/^‡πÄ‡∏Ç‡∏ï/,'').trim();
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏≥‡∏ö‡∏• (‡∏ï‡∏≥‡∏ö‡∏•‡∏°‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô suburb, village, city_district)
      if(county) dist=county;
    }

    return {province:prov,district:dist};
  }catch(e){return {province:'',district:''};}
}

// ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ parseDisplayName ‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡∏î‡∏∂‡∏á‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å regex ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function apiGet(action,params=''){
  if(!API_URL)return null;
  try{const r=await fetch(`${API_URL}?action=${action}${params}`);const j=await r.json();return j.ok?j.data:null;}catch(e){return null;}
}
async function apiPost(action,data){
  if(!API_URL)return null;
  try{const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action,...data})});const j=await r.json();return j.ok?j.data:null;}catch(e){return null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init(){
  document.getElementById('apiUrlInput').value=API_URL;
  if(!API_URL){setConn('err','‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL');switchRight('settings');return;}
  setConn('','‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  const[t,s]=await Promise.all([apiGet('getTeam'),apiGet('getShops')]);
  if(t!==null){salesTeam=t;setConn('ok','‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');}else setConn('err','‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
  if(s)shops=s;
  renderAll();
}
function setConn(c,t){const e=document.getElementById('connStatus');e.className='conn-status'+(c?' '+c:'');e.textContent=t;}
function saveApiUrl(){const u=document.getElementById('apiUrlInput').value.trim();if(!u){showToast('‡πÉ‡∏™‡πà URL',true);return;}API_URL=u;localStorage.setItem('salesmap-api-url',u);showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß');init();}

async function refreshData(){
  const btn=document.getElementById('refreshBtn');btn.disabled=true;btn.textContent='‚è≥ ...';
  const[t,s]=await Promise.all([apiGet('getTeam'),apiGet('getShops')]);
  if(t!==null)salesTeam=t;if(s)shops=s;renderAll();
  btn.disabled=false;btn.textContent='üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';showToast(`‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß: ${shops.length} ‡∏£‡πâ‡∏≤‡∏ô`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TEAM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function addSalesMember(){
  const input=document.getElementById('newSalesName'),name=input.value.trim();
  if(!name)return;if(salesTeam.includes(name)){showToast(`"${name}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`,true);return;}
  salesTeam.push(name);salesTeam.sort((a,b)=>a.localeCompare(b,'th'));
  renderTeamList();updateFilters();input.value='';document.getElementById('addSalesBtn').disabled=true;
  await apiPost('setTeam',{data:salesTeam});showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${name}"`);
}
async function removeSalesMember(name){
  if(!confirm(`‡∏•‡∏ö "${name}" ?`))return;
  salesTeam=salesTeam.filter(n=>n!==name);renderTeamList();updateFilters();
  await apiPost('setTeam',{data:salesTeam});showToast(`‡∏•‡∏ö "${name}"`);
}
function renderTeamList(){
  const el=document.getElementById('salesTeamList');
  if(!salesTeam.length){el.innerHTML='<div class="empty-team">üë• ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ã‡∏•‡∏•‡πå</div>';return;}
  el.innerHTML=salesTeam.map(name=>`<div class="team-member-card"><div class="member-avatar">üë§</div><div class="member-info"><div class="member-name">${name}</div><div class="member-stats">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${shops.filter(s=>s.sales===name).length} ‡∏£‡πâ‡∏≤‡∏ô</div></div><button class="member-remove" onclick="removeSalesMember('${name.replace(/'/g,"\\'")}')">‚úï ‡∏•‡∏ö</button></div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setDatePreset(p,btn){document.querySelectorAll('.date-preset').forEach(b=>b.classList.remove('active'));const n=new Date();let f;const t=fmtD(n);if(p==='today')f=t;else if(p==='week'){const d=new Date(n);d.setDate(d.getDate()-6);f=fmtD(d);}else{const d=new Date(n);d.setDate(d.getDate()-29);f=fmtD(d);}document.getElementById('dateFrom').value=f;document.getElementById('dateTo').value=t;document.getElementById('dateClearBtn').style.display='inline-block';btn.classList.add('active');renderTable();}
function onDateChange(){document.querySelectorAll('.date-preset').forEach(b=>b.classList.remove('active'));const f=document.getElementById('dateFrom').value,t=document.getElementById('dateTo').value;document.getElementById('dateClearBtn').style.display=(f||t)?'inline-block':'none';renderTable();}
function clearDateFilter(){document.getElementById('dateFrom').value='';document.getElementById('dateTo').value='';document.getElementById('dateClearBtn').style.display='none';document.querySelectorAll('.date-preset').forEach(b=>b.classList.remove('active'));renderTable();}
function fmtD(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getFiltered(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase();
  const prov=document.getElementById('filterProv').value;
  const dist=document.getElementById('filterDistrict').value;
  const sales=document.getElementById('filterSales').value;
  const df=document.getElementById('dateFrom').value,dt=document.getElementById('dateTo').value;
  return shops.filter(s=>{
    if(q&&!s.name.toLowerCase().includes(q)&&!(s.phone||'').includes(q)&&!(s.district||'').toLowerCase().includes(q))return false;
    if(prov&&s.province!==prov)return false;
    if(dist&&s.district!==dist)return false;
    if(sales&&s.sales!==sales)return false;
    if(df||dt){const sd=(s.createdAt||'').slice(0,10);if(df&&sd<df)return false;if(dt&&sd>dt)return false;}
    return true;
  }).sort((a,b)=>{const va=a[sortField]||'',vb=b[sortField]||'';return(typeof va==='string'?va.localeCompare(vb):va-vb)*sortDir;});
}
function sortBy(f){if(sortField===f)sortDir*=-1;else{sortField=f;sortDir=1;}renderTable();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){updateStats();updateFilters();renderTable();renderMarkers();renderTeamList();}
function updateStats(){
  document.getElementById('statTotal').textContent=shops.length;
  document.getElementById('statProvince').textContent=new Set(shops.map(s=>s.province).filter(Boolean)).size;
  document.getElementById('statSales').textContent=salesTeam.length;
  const n=new Date();document.getElementById('statMonth').textContent=shops.filter(s=>{const d=new Date(s.createdAt);return d.getMonth()===n.getMonth()&&d.getFullYear()===n.getFullYear();}).length;
}
function updateFilters(){
  const provs=[...new Set(shops.map(s=>s.province).filter(Boolean))].sort();
  const dists=[...new Set(shops.map(s=>s.district).filter(Boolean))].sort();
  const salesIn=[...new Set(shops.map(s=>s.sales).filter(Boolean))];
  const allSales=[...new Set([...salesTeam,...salesIn])].sort((a,b)=>a.localeCompare(b,'th'));

  const pEl=document.getElementById('filterProv'),cur=pEl.value;
  pEl.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>'+provs.map(p=>`<option ${p===cur?'selected':''}>${p}</option>`).join('');

  const dEl=document.getElementById('filterDistrict'),curD=dEl.value;
  // Filter districts by selected province
  let filteredDists=dists;
  if(cur){filteredDists=[...new Set(shops.filter(s=>s.province===cur).map(s=>s.district).filter(Boolean))].sort();}
  dEl.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>'+filteredDists.map(d=>`<option ${d===curD?'selected':''}>${d}</option>`).join('');

  const sEl=document.getElementById('filterSales'),curS=sEl.value;
  sEl.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option>'+allSales.map(s=>`<option ${s===curS?'selected':''}>${s}</option>`).join('');
}

// Refresh district dropdown when province changes
document.getElementById('filterProv').addEventListener('change',()=>{
  document.getElementById('filterDistrict').value='';
  updateFilters();renderTable();
});

function renderTable(){
  const filtered=getFiltered(),tbody=document.getElementById('tableBody');
  if(!filtered.length){tbody.innerHTML=`<tr><td colspan="10" class="empty-state">${shops.length?'üîç ‡πÑ‡∏°‡πà‡∏û‡∏ö':'üìç ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</td></tr>`;updateSelection();return;}
  tbody.innerHTML=filtered.map(s=>{
    const d=new Date(s.createdAt);const ds=d.toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'2-digit'});
    return `<tr class="${selected.has(s.id)?'selected':''}" ondblclick="editShop('${s.id}')">
      <td class="cb-cell"><input type="checkbox" ${selected.has(s.id)?'checked':''} onchange="toggleSelect('${s.id}')"></td>
      <td class="cell-name">${s.name}</td>
      <td>${s.province?`<span class="cell-loc">${s.province}</span>`:'-'}</td>
      <td>${s.district?`<span class="cell-loc">${s.district}</span>`:'-'}</td>
      <td class="cell-sales">${s.sales||'-'}</td>
      <td>${s.phone||'-'}</td>
      <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;color:var(--text-dim);font-size:12px">${s.note||'-'}</td>
      <td class="cell-coord">${parseFloat(s.lat).toFixed(5)}, ${parseFloat(s.lng).toFixed(5)}</td>
      <td class="cell-date">${ds}</td>
      <td><div class="row-actions">
        <button class="row-btn" onclick="focusMap('${s.id}')">üó∫Ô∏è</button>
        <button class="row-btn" onclick="window.open('https://www.google.com/maps?q=${s.lat},${s.lng}','_blank')">üß≠</button>
        <button class="row-btn" onclick="editShop('${s.id}')">‚úèÔ∏è</button>
      </div></td></tr>`;
  }).join('');
  updateSelection();renderMarkers();
}

function toggleSelect(id){if(selected.has(id))selected.delete(id);else selected.add(id);renderTable();}
function toggleSelectAll(){const a=document.getElementById('selectAll').checked;if(a)getFiltered().forEach(s=>selected.add(s.id));else selected.clear();renderTable();}
function updateSelection(){const i=document.getElementById('selectionInfo'),b=document.getElementById('bulkDeleteBtn');if(selected.size){i.innerHTML=`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>${selected.size}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;b.style.display='flex';}else{i.textContent=`${getFiltered().length} / ${shops.length}`;b.style.display='none';}}
async function bulkDelete(){if(!confirm(`‡∏•‡∏ö ${selected.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?`))return;const ids=[...selected];shops=shops.filter(s=>!selected.has(s.id));selected.clear();renderAll();await apiPost('deleteShops',{ids});showToast('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');}

function focusMap(id){const s=shops.find(x=>x.id===id);if(s){switchRight('map');setTimeout(()=>{map.invalidateSize();map.setView([s.lat,s.lng],16);if(markers[id])markers[id].openPopup();},150);}}
async function deleteShop(id){const s=shops.find(x=>x.id===id);if(!s||!confirm(`‡∏•‡∏ö "${s.name}" ?`))return;shops=shops.filter(x=>x.id!==id);selected.delete(id);renderAll();await apiPost('deleteShop',{id});showToast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateModalSales(){
  const sel=document.getElementById('mSales'),cur=sel.value;
  const all=[...new Set([...salesTeam,...shops.map(s=>s.sales).filter(Boolean)])].sort((a,b)=>a.localeCompare(b,'th'));
  sel.innerHTML='<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>'+all.map(s=>`<option ${s===cur?'selected':''}>${s}</option>`).join('');
}

function showAddModal(){
  editingId='__new__';document.getElementById('modalTitle').textContent='‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
  ['mName','mPhone','mLat','mLng','mNote','mProvince','mDistrict'].forEach(id=>document.getElementById(id).value='');
  populateModalSales();document.getElementById('mSales').value='';
  document.getElementById('editModal').classList.add('show');
}
function editShop(id){
  const s=shops.find(x=>x.id===id);if(!s)return;editingId=id;
  document.getElementById('modalTitle').textContent='‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤';
  document.getElementById('mName').value=s.name;document.getElementById('mLat').value=s.lat;document.getElementById('mLng').value=s.lng;
  document.getElementById('mProvince').value=s.province||'';document.getElementById('mDistrict').value=s.district||'';
  populateModalSales();document.getElementById('mSales').value=s.sales||'';
  document.getElementById('mPhone').value=s.phone||'';document.getElementById('mNote').value=s.note||'';
  document.getElementById('editModal').classList.add('show');
}

async function geocodeModal(){
  const lat=parseFloat(document.getElementById('mLat').value),lng=parseFloat(document.getElementById('mLng').value);
  if(isNaN(lat)||isNaN(lng)){showToast('‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô',true);return;}
  showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á...');
  const r=await reverseGeocode(lat,lng);
  document.getElementById('mProvince').value=r.province;
  document.getElementById('mDistrict').value=r.district;
  showToast(r.province?`‡∏û‡∏ö: ‡∏≠.${r.district} ‡∏à.${r.province}`:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
}

async function saveModal(){
  const name=document.getElementById('mName').value.trim();
  const lat=parseFloat(document.getElementById('mLat').value),lng=parseFloat(document.getElementById('mLng').value);
  if(!name){showToast('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô',true);return;}if(isNaN(lat)||isNaN(lng)){showToast('‡πÉ‡∏™‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î',true);return;}
  const data={
    id:editingId==='__new__'?Date.now().toString(36)+Math.random().toString(36).substr(2,5):editingId,
    name,lat,lng,
    province:document.getElementById('mProvince').value.trim(),
    district:document.getElementById('mDistrict').value.trim(),
    sales:document.getElementById('mSales').value,
    phone:document.getElementById('mPhone').value.trim(),
    note:document.getElementById('mNote').value.trim(),
    createdAt:editingId==='__new__'?new Date().toISOString():(shops.find(x=>x.id===editingId)||{}).createdAt||new Date().toISOString()
  };
  if(editingId==='__new__'){shops.push(data);await apiPost('addShop',{data});showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° "${name}"`);}
  else{const i=shops.findIndex(x=>x.id===editingId);if(i>-1)shops[i]=data;await apiPost('updateShop',{data});showToast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');}
  closeModal('editModal');renderAll();
}
function closeModal(id){document.getElementById(id).classList.remove('show');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(){
  const f=getFiltered();if(!f.length){showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',true);return;}
  const h='‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô,‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î,‡∏≠‡∏≥‡πÄ‡∏†‡∏≠,‡πÄ‡∏ã‡∏•‡∏•‡πå,‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';
  const rows=f.map(s=>`"${s.name}","${s.province||''}","${s.district||''}","${s.sales||''}","${s.phone||''}","${(s.note||'').replace(/"/g,'""')}",${s.lat},${s.lng},"${new Date(s.createdAt).toLocaleString('th-TH')}"`);
  dl('\ufeff'+h+'\n'+rows.join('\n'),`shops-${ds()}.csv`,'text/csv;charset=utf-8');showToast(`Export ${f.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
}
function exportJSON(){const f=getFiltered();if(!f.length){showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',true);return;}dl(JSON.stringify(f,null,2),`shops-${ds()}.json`,'application/json');showToast(`Export ${f.length}`);}
function dl(c,fn,t){const b=new Blob([c],{type:t}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);}
function ds(){const d=new Date();return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showImportModal(){csvRows=[];document.getElementById('csvFile').value='';document.getElementById('importPreview').textContent='';document.getElementById('importBtn').style.display='none';document.getElementById('geocodeCheck').style.display='none';document.getElementById('importProgress').style.display='none';document.getElementById('importModal').classList.add('show');}

function handleCSV(e){
  const f=e.target.files[0];if(!f)return;

  // ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô ArrayBuffer ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ TextDecoder ‚Äî ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö encoding ‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å Excel
  const reader=new FileReader();
  reader.onload=ev=>{
    const buf=ev.target.result;
    const bytes=new Uint8Array(buf);

    // ‡∏ï‡∏£‡∏ß‡∏à BOM ‡∏Ç‡∏≠‡∏á UTF-8 (EF BB BF)
    const hasUtf8Bom=(bytes[0]===0xEF && bytes[1]===0xBB && bytes[2]===0xBF);

    let text;
    if(hasUtf8Bom){
      // ‡∏°‡∏µ BOM = UTF-8 ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô
      text=new TextDecoder('utf-8').decode(buf);
    } else {
      // ‡∏•‡∏≠‡∏á UTF-8 ‡∏Å‡πà‡∏≠‡∏ô
      text=new TextDecoder('utf-8').decode(buf);

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤ + ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤
      const hasThai=/[\u0E00-\u0E7F]/.test(text);
      const hasGarbled=/[\u00C0-\u00FF]{2,}/.test(text) || /\uFFFD/.test(text);

      if(!hasThai || hasGarbled){
        // UTF-8 ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å ‚Üí ‡∏•‡∏≠‡∏á windows-874 (Excel ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
        try{
          text=new TextDecoder('windows-874').decode(buf);
        }catch(e2){
          // ‡∏ñ‡πâ‡∏≤ browser ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å windows-874 ‡∏•‡∏≠‡∏á tis-620
          try{
            text=new TextDecoder('tis-620').decode(buf);
          }catch(e3){
            // fallback ‡∏Å‡∏•‡∏±‡∏ö UTF-8
            text=new TextDecoder('utf-8').decode(buf);
          }
        }
      }
    }

    processCSVText(text);
  };
  reader.readAsArrayBuffer(f);
}

function processCSVText(text){
  // Strip BOM
  if(text.charCodeAt(0)===0xFEFF) text=text.slice(1);

  const lines=text.split(/\r?\n/).filter(l=>l.trim());
  if(lines.length<2){document.getElementById('importPreview').textContent='‚ùå ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';return;}
  csvRows=[];
  for(let i=1;i<lines.length;i++){
    const c=parseCSVLine(lines[i]);
    if(c.length>=3){
      csvRows.push({
        name:(c[0]||'').trim(),
        lat:parseFloat(c[1]),
        lng:parseFloat(c[2]),
        sales:(c[3]||'').trim(),
        phone:(c[4]||'').trim(),
        note:(c[5]||'').trim()
      });
    }
  }
  const valid=csvRows.filter(r=>r.name&&!isNaN(r.lat)&&!isNaN(r.lng));
  document.getElementById('importPreview').innerHTML=`‚úÖ ‡∏û‡∏ö <b>${valid.length}</b> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` +
    (valid.length?` ‚Äî ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: "${valid[0].name}"`:' (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå)');
  document.getElementById('geocodeCheck').style.display=valid.length?'flex':'none';
  document.getElementById('importBtn').style.display=valid.length?'block':'none';
  csvRows=valid;
}
function parseCSVLine(l){const r=[];let c='',q=false;for(let i=0;i<l.length;i++){const ch=l[i];if(ch==='"')q=!q;else if(ch===','&&!q){r.push(c.trim());c='';}else c+=ch;}r.push(c.trim());return r;}

async function doImport(){
  const doGeo=document.getElementById('autoGeocode').checked;
  const prog=document.getElementById('importProgress');
  const progText=document.getElementById('progressText');
  const progFill=document.getElementById('progressFill');
  const importBtn=document.getElementById('importBtn');
  const cancelBtn=document.getElementById('importCancelBtn');

  importBtn.style.display='none';
  cancelBtn.style.display='none';
  prog.style.display='block';

  const newShops=[];

  for(let i=0;i<csvRows.length;i++){
    const row=csvRows[i];
    progText.textContent=`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• ${i+1}/${csvRows.length}: ${row.name}`;
    progFill.style.width=((i+1)/csvRows.length*100)+'%';

    let province='',district='';
    if(doGeo){
      const geo=await reverseGeocode(row.lat,row.lng);
      province=geo.province;district=geo.district;
      // Nominatim rate limit: 1 request/sec
      if(i<csvRows.length-1) await new Promise(r=>setTimeout(r,1100));
    }

    const shop={
      id:Date.now().toString(36)+Math.random().toString(36).substr(2,8),
      name:row.name,lat:row.lat,lng:row.lng,
      province,district,
      sales:row.sales,phone:row.phone||'',note:row.note||'',
      createdAt:new Date().toISOString()
    };
    shops.push(shop);
    newShops.push(shop);
  }

  // Batch save to Google Sheets
  progText.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets...';
  await apiPost('addShops',{data:newShops});

  closeModal('importModal');renderAll();
  showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${newShops.length} ‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchRight(tab){
  document.querySelectorAll('.right-tab').forEach((el,i)=>el.classList.toggle('active',(tab==='map'&&i===0)||(tab==='settings'&&i===1)));
  document.getElementById('rightMap').classList.toggle('active',tab==='map');
  document.getElementById('rightSettings').classList.toggle('active',tab==='settings');
  if(tab==='map')setTimeout(()=>map.invalidateSize(),100);
  if(tab==='settings')renderTeamList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EXPORT FULL-SCREEN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let exportSelected=new Set();

function openExportPage(){
  document.getElementById('exportOverlay').classList.add('show');
  populateExFilters();renderExportTable();renderExportRight();updateExCount();
}
function closeExportPage(){document.getElementById('exportOverlay').classList.remove('show');}

function populateExFilters(){
  const provs=[...new Set(shops.map(s=>s.province).filter(Boolean))].sort();
  const selP=document.getElementById('exFilterProv'),curP=selP.value;
  selP.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>'+provs.map(p=>`<option value="${p}"${p===curP?' selected':''}>${p}</option>`).join('');
  onExProvChange();
  const sales=[...new Set(shops.map(s=>s.sales).filter(Boolean))].sort();
  const selS=document.getElementById('exFilterSales'),curS=selS.value;
  selS.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏ã‡∏•‡∏•‡πå</option>'+sales.map(s=>`<option value="${s}"${s===curS?' selected':''}>${s}</option>`).join('');
}
function onExProvChange(){
  const prov=document.getElementById('exFilterProv').value;
  const dists=[...new Set(shops.filter(s=>!prov||s.province===prov).map(s=>s.district).filter(Boolean))].sort();
  const selD=document.getElementById('exFilterDistrict'),curD=selD.value;
  selD.innerHTML='<option value="">‡∏ó‡∏∏‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</option>'+dists.map(d=>`<option value="${d}"${d===curD?' selected':''}>${d}</option>`).join('');
}
function getExFiltered(){
  const prov=document.getElementById('exFilterProv').value;
  const dist=document.getElementById('exFilterDistrict').value;
  const sales=document.getElementById('exFilterSales').value;
  const from=document.getElementById('exDateFrom').value;
  const to=document.getElementById('exDateTo').value;
  const q=(document.getElementById('exSearch').value||'').toLowerCase();
  document.getElementById('exDateClear').style.display=(from||to)?'inline':'none';
  return shops.filter(s=>{
    if(prov && s.province!==prov) return false;
    if(dist && s.district!==dist) return false;
    if(sales && s.sales!==sales) return false;
    if(from){const d=s.createdAt?s.createdAt.slice(0,10):'';if(d<from) return false;}
    if(to){const d=s.createdAt?s.createdAt.slice(0,10):'';if(d>to) return false;}
    if(q && !s.name.toLowerCase().includes(q) && !(s.district||'').toLowerCase().includes(q) && !(s.phone||'').includes(q)) return false;
    return true;
  });
}
function clearExDateFilter(){document.getElementById('exDateFrom').value='';document.getElementById('exDateTo').value='';document.getElementById('exDateClear').style.display='none';renderExportTable();}

function renderExportTable(){
  const list=getExFiltered();
  const el=document.getElementById('exTableBody');
  document.getElementById('exLeftBadge').textContent=list.length+' ‡∏£‡πâ‡∏≤‡∏ô';
  updateExCount();

  if(!list.length){el.innerHTML=`<tr><td colspan="8" class="ex-empty">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</td></tr>`;return;}
  el.innerHTML=list.map(s=>{
    const checked=exportSelected.has(s.id);
    const d=s.createdAt?new Date(s.createdAt).toLocaleDateString('th-TH',{day:'numeric',month:'short',year:'2-digit'}):'';
    return `<tr class="${checked?'ex-selected':''}">
      <td class="cb-cell"><input type="checkbox" ${checked?'checked':''} onchange="toggleExItem('${s.id}',this.checked)"></td>
      <td class="ex-cell-name">${s.name}</td>
      <td>${s.province?`<span class="ex-cell-loc">${s.province}</span>`:'-'}</td>
      <td>${s.district?`<span class="ex-cell-loc">${s.district}</span>`:'-'}</td>
      <td class="ex-cell-sales">${s.sales||'-'}</td>
      <td>${s.phone||'-'}</td>
      <td class="ex-cell-coord">${s.lat}, ${s.lng}</td>
      <td class="ex-cell-date">${d}</td>
    </tr>`;
  }).join('');
  document.getElementById('exSelectAll').checked=list.length>0&&list.every(s=>exportSelected.has(s.id));
}

function renderExportRight(){
  const q=(document.getElementById('exSearchRight').value||'').toLowerCase();
  const items=shops.filter(s=>exportSelected.has(s.id)&&(!q||s.name.toLowerCase().includes(q)));
  const el=document.getElementById('exRightList');
  if(!exportSelected.size){el.innerHTML='<div class="ex-right-empty">‚Üê ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢<br><br>‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î <b>"‚äï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á"</b><br>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∏‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏≤‡∏° filter ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</div>';return;}
  el.innerHTML=items.map(s=>{
    let sub=[];if(s.district)sub.push('‡∏≠.'+s.district);if(s.sales)sub.push(s.sales);
    return `<div class="ex-right-item" onclick="removeExItem('${s.id}')">
      <div class="ex-right-item-name">${s.name}</div>
      ${sub.length?`<div class="ex-right-item-sub">${sub.join(' ¬∑ ')}</div>`:''}
      <div class="ex-right-item-remove">‚úï</div>
    </div>`;
  }).join('');
  // summary
  const provs=[...new Set(shops.filter(s=>exportSelected.has(s.id)).map(s=>s.province).filter(Boolean))];
  const salesList=[...new Set(shops.filter(s=>exportSelected.has(s.id)).map(s=>s.sales).filter(Boolean))];
  document.getElementById('exRightSummary').innerHTML=`<b>${exportSelected.size}</b> ‡∏£‡πâ‡∏≤‡∏ô ¬∑ ${provs.length} ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ¬∑ ${salesList.length} ‡πÄ‡∏ã‡∏•‡∏•‡πå`;
}

function toggleExItem(id,checked){
  if(checked) exportSelected.add(id); else exportSelected.delete(id);
  renderExportTable();renderExportRight();
}
function removeExItem(id){exportSelected.delete(id);renderExportTable();renderExportRight();}
function toggleExSelectAll(){
  const list=getExFiltered();
  const allChecked=list.every(s=>exportSelected.has(s.id));
  if(allChecked) list.forEach(s=>exportSelected.delete(s.id));
  else list.forEach(s=>exportSelected.add(s.id));
  renderExportTable();renderExportRight();
}
function addAllFiltered(){
  const list=getExFiltered();
  list.forEach(s=>exportSelected.add(s.id));
  renderExportTable();renderExportRight();
  showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${exportSelected.size} ‡∏£‡πâ‡∏≤‡∏ô`);
}
function clearExportList(){exportSelected.clear();document.getElementById('exSearch').value='';document.getElementById('exSearchRight').value='';renderExportTable();renderExportRight();}
function updateExCount(){
  document.getElementById('exRightBadge').textContent=exportSelected.size+' ‡∏£‡πâ‡∏≤‡∏ô';
  document.getElementById('expGoBtn').disabled=!exportSelected.size;
  document.getElementById('expGoBtn2').disabled=!exportSelected.size;
}
function doExportSelected(){
  const items=shops.filter(s=>exportSelected.has(s.id));
  if(!items.length){showToast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô',true);return;}
  const h='‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô,‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î,‡∏≠‡∏≥‡πÄ‡∏†‡∏≠,‡πÄ‡∏ã‡∏•‡∏•‡πå,‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£,‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏,‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î,‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î,‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà';
  const rows=items.map(s=>`"${s.name}","${s.province||''}","${s.district||''}","${s.sales||''}","${s.phone||''}","${(s.note||'').replace(/"/g,'""')}",${s.lat},${s.lng},"${new Date(s.createdAt).toLocaleString('th-TH')}"`);
  dl('\ufeff'+h+'\n'+rows.join('\n'),`shops-export-${ds()}.csv`,'text/csv;charset=utf-8');
  showToast(`üì§ Export ${items.length} ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`);
}

function showToast(m,e){const t=document.getElementById('toast');t.textContent=m;t.className='toast'+(e?' error':'');setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),2500);}

init();setTimeout(()=>map.invalidateSize(),150);
</script>
</body>
</html>
